<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAPA VOLADURA - MCP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* PANEL FLOTANTE MUY COMPACTO */
        #panel { 
            position: absolute; top: 10px; left: 10px; 
            width: 240px; background: rgba(44, 62, 80, 0.95); 
            color: white; padding: 12px; border-radius: 10px; 
            z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            font-family: 'Segoe UI', sans-serif;
        }

        h3 { margin: 0 0 8px 0; font-size: 1em; color: #2ecc71; text-align: center; }
        label { font-size: 0.7em; color: #bdc3c7; display: block; margin-top: 4px; }
        input, button { 
            width: 100%; padding: 7px; margin: 3px 0; 
            border-radius: 4px; border: none; font-size: 0.85em; 
        }
        
        .btn-graficar { background: #c0392b; color: white; font-weight: bold; cursor: pointer; }
        .btn-gps { background: #2980b9; color: white; font-weight: bold; margin-bottom: 8px; cursor: pointer; }
        #info { font-size: 0.7em; margin-top: 6px; color: #ecf0f1; text-align: center; border-top: 1px solid #555; padding-top: 5px; }

        /* Ajuste para que el selector de capas no choque con el panel en iPhone */
        .leaflet-top.leaflet-right { top: 10px; }
    </style>
</head>
<body>

<div id="panel">
    <button class="btn-gps" onclick="encontrarMiUbicacion()">üìç OBTENER MI UBICACI√ìN</button>
    
    <h3>DATOS VOLADURA</h3>
    <label>Norte (Y):</label>
    <input type="number" id="norte" value="8716250">
    <label>Este (X):</label>
    <input type="number" id="este" value="375250">
    <label>Radio Peligro (m):</label>
    <input type="number" id="radio" value="500">

    <button class="btn-graficar" onclick="procesarMapa()">GRAFICAR √ÅREA</button>
    <div id="info">Esperando se√±al GPS...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<script>
    // Configuraci√≥n del mapa
    var map = L.map('map', { zoomControl: false }).setView([-11.61, -76.02], 12);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var calles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    L.control.layers({ "Mapa": calles, "Sat√©lite": satelite }, {}, { position: 'topright' }).addTo(map);

    var capaUTM = L.layerGroup().addTo(map);
    var capaGPS = L.layerGroup().addTo(map);

    function encontrarMiUbicacion() {
        const infoDiv = document.getElementById('info');
        infoDiv.innerHTML = "üõ∞Ô∏è Buscando sat√©lites...";

        if (!navigator.geolocation) {
            alert("Tu iPhone no permite GPS en este navegador.");
            return;
        }

        // Opciones cr√≠ticas para iPhone y zonas de monta√±a
        const opcionesGps = {
            enableHighAccuracy: true, // Fuerza el uso de GPS real, no solo WiFi
            timeout: 15000,           // 15 segundos m√°ximo para encontrar se√±al
            maximumAge: 0             // No usar ubicaciones guardadas viejas
        };

        navigator.geolocation.getCurrentPosition(function(pos) {
            capaGPS.clearLayers();
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;

            // Marcador de usuario (Azul)
            L.circleMarker([lat, lon], { 
                radius: 9, 
                fillColor: "#3498db", 
                color: "#fff", 
                weight: 2, 
                fillOpacity: 1 
            }).addTo(capaGPS).bindPopup("Tu posici√≥n actual").openPopup();

            map.flyTo([lat, lon], 16);
            infoDiv.innerHTML = "‚úÖ Ubicaci√≥n actualizada.";
        }, function(err) {
            // Manejo de errores espec√≠fico para iPhone
            let mensaje = "Error desconocido.";
            if(err.code === 1) mensaje = "Permiso denegado. Ve a Ajustes > Privacidad > Localizaci√≥n.";
            if(err.code === 2) mensaje = "Se√±al de sat√©lite d√©bil.";
            if(err.code === 3) mensaje = "Tiempo de espera agotado.";
            
            alert("GPS iPhone: " + mensaje);
            infoDiv.innerHTML = "‚ùå Error GPS.";
        }, opcionesGps);
    }

    function procesarMapa() {
        capaUTM.clearLayers();
        const n = parseFloat(document.getElementById('norte').value);
        const e = parseFloat(document.getElementById('este').value);
        const r = parseFloat(document.getElementById('radio').value);
        
        // Zona 18S (Jun√≠n / Toromocho)
        const utm18S = "+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs";
        
        try {
            const coords = proj4(utm18S, "+proj=longlat +datum=WGS84 +no_defs", [e, n]);
            
            // Marcador del punto de voladura

            
            // C√çRCULO DE RADIO ROJO
            L.circle([coords[1], coords[0]], { 
                radius: r, 
                color: 'red', 
                fillColor: '#f03', 
                fillOpacity: 0.4,
                weight: 3 
            }).addTo(capaUTM);

            map.flyTo([coords[1], coords[0]], 15);
            document.getElementById('info').innerHTML = `Punto: ${coords[1].toFixed(5)}, ${coords[0].toFixed(5)}`;
        } catch (e) { 
            alert("Datos UTM inv√°lidos"); 
        }
    }
</script>
</body>
</html>