<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA GESTI√ìN TOROMOCHO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- ESTILOS GENERALES --- */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 1100; background: #2c3e50; color: white; border: none; border-radius: 4px; width: 40px; height: 40px; font-size: 1.5em; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        #panel { 
            position: absolute; top: 60px; left: 10px; width: 280px; 
            background: rgba(33, 47, 61, 0.95); color: white; padding: 10px; 
            border-radius: 8px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            max-height: 85vh; overflow-y: auto; transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }
        #panel.escondido { transform: translateX(-360%); }

        h4 { margin: 10px 0 5px 0; font-size: 0.8em; color: #2ecc71; text-transform: uppercase; text-align: center; border-bottom: 1px solid #555; padding-bottom: 5px; }
        
        button { width: 100%; padding: 12px; margin: 3px 0; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 0.75em; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-gps { background: #2980b9; color: white; }
        .btn-sync { background: #8e44ad; color: white; } 
        
        /* BOT√ìN REPORTE */
        .btn-report { 
            background: #d35400; color: white; 
            border: 1px solid #e67e22; margin-bottom: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* TABS */
        .tab-container { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .tab-btn { width: 48%; background: #34495e; color: #bdc3c7; border: 1px solid #555; padding: 8px; }
        .tab-btn.active { background: #16a085; color: white; border-color: #16a085; }

        /* LISTAS */
        .list-item { 
            background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 5px; 
            border-radius: 4px; font-size: 0.75em; border-left: 4px solid grey;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .list-item:hover { background: rgba(255,255,255,0.1); }
        .genset-item { border-left-color: #9b59b6; }
        
        /* √çCONO GENSET SVG */
        .genset-marker {
            background: #8e44ad; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px black;
            display: flex; align-items: center; justify-content: center;
        }
        .genset-marker svg { width: 18px; height: 18px; fill: white; }

        /* ALERTAS */
        #radio-silence-alert { position: absolute; bottom: 30px; left: 20px; right: 20px; background: rgba(231, 76, 60, 0.95); color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: 900; font-size: 1.2em; z-index: 2000; border: 4px solid white; display: none; box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); text-transform: uppercase; animation: parpadeo-fuerte 0.8s infinite alternate; }
        @keyframes parpadeo-fuerte { from { opacity: 1; transform: scale(1); } to { opacity: 0.9; transform: scale(1.02); } }
        
        #reloj-sistema { font-family: monospace; color: #f1c40f; text-align: center; font-size: 1.2em; margin-bottom: 10px; border: 1px solid #555; padding: 5px; background: rgba(0,0,0,0.3); }
        .storm-alert { background: rgba(52, 152, 219, 0.2); border: 2px solid #3498db; color: #f1c40f; padding: 10px; margin-bottom: 10px; text-align: center; font-size: 0.8em; display: none; font-weight: bold; border-radius: 5px; }
        .proximity-alert { background: rgba(243, 156, 18, 0.2); border: 2px solid #f39c12; color: #e67e22; padding: 10px; margin-bottom: 10px; text-align: center; font-size: 0.9em; display: none; font-weight: bold; border-radius: 5px; animation: parpadeo-suave 1s infinite alternate; }
        .proximity-critical { background: rgba(231, 76, 60, 0.3); border: 2px solid #c0392b; color: #ff6b6b; }
        @keyframes parpadeo-suave { from { opacity: 0.8; } to { opacity: 1; } }

        .footer-dev { margin-top: 20px; padding-top: 10px; border-top: 1px solid #555; text-align: center; font-size: 0.6em; color: #95a5a6; }
        .car-icon { width: 30px; height: 30px; filter: drop-shadow(0px 0px 3px black); }
        .leaflet-control-layers { border-radius: 8px; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        /* --- ESTILOS DE LA TABLA NATIVA --- */
        #tabla-dinamica { width: 100%; border-collapse: collapse; font-size: 0.85em; color: #333; }
        #tabla-dinamica th { background: #2c3e50; color: white; padding: 10px; text-align: left; position: sticky; top: 0; }
        #tabla-dinamica td { padding: 8px; border-bottom: 1px solid #ddd; }
        #tabla-dinamica tr:nth-child(even) { background-color: #f2f2f2; }
        #tabla-dinamica tr:hover { background-color: #e8f6f3; }
    </style>
</head>
<body>

<div id="radio-silence-alert">üö´ SILENCIO RADIAL ACTIVO üö´<br><span style="font-size:0.6em; font-weight:normal;">ZONA ROJA ACTIVADA</span></div>

<button id="menu-toggle" onclick="togglePanel()">‚ò∞</button>

<div id="panel">
    <div id="reloj-sistema">--:--:--</div>
    <div id="storm-box" class="storm-alert"></div>
    <div id="proximity-box" class="proximity-alert"></div>

    <button id="btnGps" class="btn-gps" onclick="iniciarSeguimiento()">üìç MI UBICACI√ìN (GPS)</button>
    <div id="utm-display" style="text-align:center; font-size:0.7em; color:#f39c12; margin-bottom:10px; font-family:monospace;">...</div>

    <div class="tab-container">
        <button class="tab-btn active" onclick="cambiarTab('voladuras')" id="tab-vol">üí• Voladura</button>
        <button class="tab-btn" onclick="cambiarTab('gensets')" id="tab-gen">‚ö° Gensets</button>
    </div>

    <button class="btn-report" onclick="cargarReporteNativo()">üìÑ VER REPORTE T√âCNICO</button>

    <button class="btn-sync" onclick="actualizarTodo()">üîÑ ACTUALIZAR DATOS</button>

    <div id="view-voladuras">
        <h4 style="color:#e74c3c">Programaci√≥n Hoy</h4>
        <div id="lista-voladuras"><em style="font-size:0.7em; color:#7f8c8d;">Cargando...</em></div>
    </div>

    <div id="view-gensets" style="display:none;">
        <h4 style="color:#9b59b6">Generadores Activos</h4>
        <div id="lista-gensets"><em style="font-size:0.7em; color:#7f8c8d;">Sin datos...</em></div>
    </div>

    <div class="footer-dev">Dev: <b>Johann Handel CP</b></div>
</div>

<div id="modal-reporte" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; width:95%; height:85%; max-width:800px; border-radius:10px; overflow:hidden; position:relative; display:flex; flex-direction:column; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
        <div style="background:#2c3e50; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold;">üìã REPORTE DE EQUIPOS</span>
            <button onclick="cerrarReporte()" style="background:#e74c3c; border:none; color:white; font-weight:bold; width:30px; height:30px; border-radius:50%; cursor:pointer; font-size:16px;">X</button>
        </div>
        <div id="contenedor-tabla" style="overflow:auto; padding:0; height:100%; background:white;">
            <div style="padding:20px; text-align:center; color:grey;">Cargando datos...</div>
        </div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<script>
    // ======================================================
    // üîó CONFIGURACI√ìN DE ENLACES
    // ======================================================
    var LINK_VOLADURAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=0&single=true&output=csv";
    
    var LINK_GENSETS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=2066463473&single=true&output=csv"; 
    
    // ‚ö†Ô∏è CAMBIA ESTO POR TU ENLACE CSV DEL REPORTE (NO HTML)
    // Debe terminar en &output=csv
    var LINK_REPORTE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=528288056&single=true&output=csv";
    // ======================================================

    function togglePanel() { document.getElementById('panel').classList.toggle('escondido'); }
    
    function cambiarTab(tab) {
        document.getElementById('view-voladuras').style.display = (tab === 'voladuras') ? 'block' : 'none';
        document.getElementById('view-gensets').style.display = (tab === 'gensets') ? 'block' : 'none';
        document.getElementById('tab-vol').className = (tab === 'voladuras') ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-gen').className = (tab === 'gensets') ? 'tab-btn active' : 'tab-btn';
    }

    // --- NUEVA FUNCI√ìN: CARGAR REPORTE NATIVO (SIN IFRAME) ---
    async function cargarReporteNativo() {
        var modal = document.getElementById('modal-reporte');
        var contenedor = document.getElementById('contenedor-tabla');
        
        modal.style.display = "flex";
        contenedor.innerHTML = '<div style="padding:20px; text-align:center; color:grey;">‚è≥ Descargando datos...</div>';

        try {
            const response = await fetch(LINK_REPORTE_CSV + '&t=' + Date.now());
            const text = await response.text();
            const filas = text.split('\n');

            let htmlTabla = '<table id="tabla-dinamica">';
            
            // Recorremos las filas del CSV
            for (let i = 0; i < filas.length; i++) {
                if(filas[i].trim() === "") continue;
                
                var celdas = filas[i].split(','); // Ojo: Si tus datos tienen comas, esto es simple
                
                htmlTabla += '<tr>';
                for (let j = 0; j < celdas.length; j++) {
                    // Si es la primera fila (0), usamos TH, si no TD
                    var tag = (i === 0) ? 'th' : 'td';
                    htmlTabla += `<${tag}>${celdas[j]}</${tag}>`;
                }
                htmlTabla += '</tr>';
            }
            htmlTabla += '</table>';
            
            contenedor.innerHTML = htmlTabla;

        } catch (error) {
            contenedor.innerHTML = '<div style="padding:20px; text-align:center; color:red;">‚ùå Error al cargar reporte.<br>Revisa el enlace CSV.</div>';
        }
    }

    function cerrarReporte() {
        document.getElementById('modal-reporte').style.display = "none";
    }

    setInterval(() => {
        document.getElementById("reloj-sistema").innerText = new Date().toLocaleTimeString('es-PE', { hour12: false });
    }, 1000);

    proj4.defs("EPSG:32718", "+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
    var map = L.map('map', { zoomControl: false }).setView([-11.619, -76.08], 13);

    var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
    var mapaPlano = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
    var mapaTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'OTM' });

    mapaSatelite.addTo(map);
    
    var capaVoladuras = L.layerGroup().addTo(map);
    var capaGensets = L.layerGroup().addTo(map);
    var capaGPS = L.layerGroup().addTo(map);
    var capaTormentas = L.layerGroup().addTo(map);
    var lineaDistancia = L.layerGroup().addTo(map);

    L.control.layers(
        { "üåé Sat√©lite": mapaSatelite, "üó∫Ô∏è Plano": mapaPlano, "‚õ∞Ô∏è Topogr√°fico": mapaTopo }, 
        { "‚ö° Sensores": capaTormentas, "üí• Voladuras": capaVoladuras, "üü£ Gensets": capaGensets }, 
        { position: 'topright' }
    ).addTo(map);

    const sensores = [
        { nombre: "MINA", lat: -11.61543, lon: -76.14331 },
        { nombre: "CARHUACOTO", lat: -11.58529, lon: -76.06169 },
        { nombre: "TUNSHURUCO", lat: -11.67360, lon: -76.13777 },
        { nombre: "KINGSMILL", lat: -11.63342, lon: -76.05691 }
    ];
    sensores.forEach(s => {
        L.marker([s.lat, s.lon], {icon: L.divIcon({html:'‚ö°', className:''})}).addTo(capaTormentas);
        L.circle([s.lat, s.lon], {radius: 5200, color:'#3498db', fillColor:'#3498db', fillOpacity:0.15, weight:1}).addTo(capaTormentas);
    });

    var zonasProgramadas = [];
    var zonasActivasAhora = []; 
    var intervaloChequeo = null;

    function actualizarTodo() {
        cargarVoladuras();
        cargarGensets();
    }

    async function cargarVoladuras() {
        var btn = document.querySelector(".btn-sync");
        btn.innerHTML = "‚è≥ CARGANDO...";
        try {
            const response = await fetch(LINK_VOLADURAS + '&t=' + Date.now());
            const text = await response.text();
            zonasProgramadas = [];
            const filas = text.split('\n');
            for (let i = 1; i < filas.length; i++) {
                const col = filas[i].split(',');
                if (col.length >= 6 && col[0].trim() !== "") {
                    zonasProgramadas.push({
                        n: parseFloat(col[0]), e: parseFloat(col[1]), r: parseFloat(col[2]),
                        detalle: col[3], hora: col[4].trim(), dur: parseInt(col[5])
                    });
                }
            }
            if (intervaloChequeo) clearInterval(intervaloChequeo);
            actualizarMapaSegunHora();
            intervaloChequeo = setInterval(actualizarMapaSegunHora, 1000);
            btn.innerHTML = "‚úÖ LISTO"; setTimeout(() => { btn.innerHTML = "üîÑ ACTUALIZAR DATOS"; }, 3000);
        } catch (err) { console.error(err); btn.innerHTML = "‚ùå ERROR VOL"; }
    }

    async function cargarGensets() {
        if (!LINK_GENSETS.startsWith("http")) return; 
        try {
            const response = await fetch(LINK_GENSETS + '&t=' + Date.now());
            const text = await response.text();
            const filas = text.split('\n');
            capaGensets.clearLayers();
            const listaDiv = document.getElementById("lista-gensets");
            listaDiv.innerHTML = "";

            for (let i = 1; i < filas.length; i++) {
                const col = filas[i].split(',');
                if (col.length >= 4 && col[0].trim() !== "") {
                    const n = parseFloat(col[0]);
                    const e = parseFloat(col[1]);
                    const nombre = col[2];
                    const estado = col[3] ? col[3].trim().toUpperCase() : "";
                    const lugar = col[4] || "Sin datos";
                    const horas = col[5] || "-";
                    const tension = col[6] || "-";

                    if (estado.includes("TRABAJANDO") && !isNaN(n)) {
                        try {
                            const c = proj4("EPSG:32718", "EPSG:4326", [e, n]);
                            const lat = c[1]; const lon = c[0];

                            const iconoGenset = L.divIcon({
                                className: 'genset-marker',
                                html: `<svg viewBox="0 0 24 24"><path d="M4 6h16v10H4z"/><path d="M6 8h12v6H6z" fill="#8e44ad"/><path d="M7 9h3v4H7zm4 0h3v4h-3zm4 0h3v4h-3z" fill="white"/><path d="M5 16v3h2v-3m10 0v3h2v-3" stroke="white" stroke-width="2"/></svg>`,
                                iconSize: [28, 28], iconAnchor: [14, 14]
                            });

                            const popupContent = `
                                <div style="min-width:180px;">
                                    <h3 style="margin:0; color:#8e44ad; border-bottom:1px solid #ccc;">${nombre}</h3>
                                    <table class="tabla-info">
                                        <tr><td>Estado:</td><td><b style="color:#27ae60">${estado}</b></td></tr>
                                        <tr><td>Lugar:</td><td>${lugar}</td></tr>
                                        <tr><td>Horas:</td><td>${horas} hrs</td></tr>
                                        <tr><td>Tensi√≥n:</td><td>${tension}</td></tr>
                                        <tr><td>Coord:</td><td><small>${n}, ${e}</small></td></tr>
                                    </table>
                                </div>`;

                            L.marker([lat, lon], {icon: iconoGenset}).bindPopup(popupContent).addTo(capaGensets);

                            listaDiv.innerHTML += `
                                <div class="list-item genset-item" onclick="viajarA(${lat}, ${lon})">
                                    <div><strong>${nombre}</strong><br><small>${lugar}</small></div>
                                    <div style="font-size:1.2em; color:#8e44ad">‚ö°</div>
                                </div>`;
                        } catch(e) {}
                    }
                }
            }
            if (listaDiv.innerHTML === "") listaDiv.innerHTML = "<div style='text-align:center;color:grey'>No hay gensets activos.</div>";
        } catch (err) { console.error("Error Gensets", err); }
    }

    window.viajarA = function(lat, lon) {
        map.flyTo([lat, lon], 18);
        if (window.innerWidth < 600) togglePanel();
    };

    function actualizarMapaSegunHora() {
        const ahora = new Date();
        const listaDiv = document.getElementById("lista-voladuras");
        const alertaDiv = document.getElementById("radio-silence-alert");
        listaDiv.innerHTML = ""; capaVoladuras.clearLayers(); 
        let haySilencioRadial = false; zonasActivasAhora = [];

        zonasProgramadas.forEach(zona => {
            if (!zona.hora) return;
            const [hh, mm] = zona.hora.split(':');
            const fechaInicio = new Date(); fechaInicio.setHours(hh, mm, 0);
            const fechaFin = new Date(fechaInicio.getTime() + zona.dur * 60000);
            let estadoTexto = ""; let colorBorde = ""; let colorMapa = ""; let dibujar = false; let esPeligroso = false;

            if (ahora > fechaFin) {
                estadoTexto = "FINALIZADO"; colorBorde = "#7f8c8d";
            } else if (ahora >= fechaInicio && ahora <= fechaFin) {
                estadoTexto = "üö® EN EJECUCI√ìN"; colorBorde = "#e74c3c"; colorMapa = "red"; dibujar = true; haySilencioRadial = true; esPeligroso = true;
            } else {
                estadoTexto = "‚è≥ PROGRAMADO"; colorBorde = "#f39c12"; colorMapa = "orange"; dibujar = true; esPeligroso = true;
            }

            if (dibujar && !isNaN(zona.n)) {
                try {
                    const c = proj4("EPSG:32718", "EPSG:4326", [zona.e, zona.n]);
                    if (esPeligroso) zonasActivasAhora.push({ center: L.latLng(c[1], c[0]), radius: zona.r, name: zona.detalle, type: colorMapa });
                    const colorHex = (colorMapa === "red") ? "#e74c3c" : "#f39c12";
                    const opacidad = (colorMapa === "red") ? 0.5 : 0.2;
                    L.circle([c[1], c[0]], { radius: zona.r, color: colorHex, fillColor: colorHex, fillOpacity: opacidad, weight: 2 }).bindPopup(`<b>${zona.detalle}</b><br>${zona.hora}`).addTo(capaVoladuras);
                } catch(e) {}
            }

            if (estadoTexto !== "FINALIZADO" || (ahora - fechaFin) < 7200000) {
                listaDiv.innerHTML += `
                    <div class="list-item" style="border-left-color: ${colorBorde};">
                        <div><strong style="font-size:1.1em">${zona.detalle}</strong><br><span style="color:${colorBorde}; font-weight:bold;">${estadoTexto}</span></div>
                        <div style="text-align:right;">${zona.hora}<br><small>${zona.dur} min</small></div>
                    </div>`;
            }
        });

        alertaDiv.style.display = haySilencioRadial ? "block" : "none";
        if (listaDiv.innerHTML === "") listaDiv.innerHTML = "<div style='text-align:center; padding:10px; color:#7f8c8d;'>Sin voladuras pendientes.</div>";
        if (miPosicion) chequearProximidadVoladura();
    }

    var truckIcon = L.divIcon({ className: 'car-container', html: `<svg class="car-icon" viewBox="0 0 24 24" fill="#00FF00" xmlns="http://www.w3.org/2000/svg"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5H6.5C5.84 5 5.28 5.42 5.08 6.01L3 12V20C3 20.55 3.45 21 4 21H5C5.55 21 6 20.55 6 20V19H18V20C18 20.55 18.45 21 19 21H20C20.55 21 21 20.55 21 20V12L18.92 6.01ZM6.5 16C5.67 16 5 15.33 5 14.5C5 13.67 5.67 13 6.5 13C7.33 13 8 13.67 8 14.5C8 15.33 7.33 16 6.5 16ZM17.5 16C16.67 16 16 15.33 16 14.5C16 13.67 16.67 13 17.5 13C18.33 13 19 13.67 19 14.5C19 15.33 18.33 16 17.5 16ZM5 11L6.5 6.5H17.5L19 11H5Z"/></svg>`, iconSize: [30, 30], iconAnchor: [15, 15] });
    var marcadorVehiculo = null;
    var miPosicion = null;

    function iniciarSeguimiento() {
        var btn = document.getElementById("btnGps");
        if (!navigator.geolocation) { alert("Sin GPS"); return; }
        btn.innerHTML = "üîÑ BUSCANDO..."; btn.style.backgroundColor = "#e67e22";
        navigator.geolocation.watchPosition((pos) => {
            var lat = pos.coords.latitude; var lon = pos.coords.longitude;
            miPosicion = L.latLng(lat, lon);
            try {
                var utm = proj4("EPSG:4326", "EPSG:32718", [lon, lat]);
                document.getElementById("utm-display").innerHTML = `N: ${utm[1].toFixed(0)} | E: ${utm[0].toFixed(0)}`;
            } catch(e) {}
            btn.innerHTML = "‚úÖ GPS ACTIVO"; btn.style.backgroundColor = "#27ae60";
            if (!marcadorVehiculo) { marcadorVehiculo = L.marker([lat, lon], {icon: truckIcon}).addTo(capaGPS); map.flyTo([lat, lon], 16); }
            else { marcadorVehiculo.setLatLng([lat, lon]); }
            chequearTormentas(); chequearProximidadVoladura();
        }, (err) => { btn.innerHTML = "‚ö†Ô∏è SIN SE√ëAL"; btn.style.backgroundColor = "#c0392b"; }, { enableHighAccuracy: true });
    }

    function chequearProximidadVoladura() {
        if (!miPosicion || zonasActivasAhora.length === 0) { document.getElementById("proximity-box").style.display = "none"; return; }
        var box = document.getElementById("proximity-box");
        var alertaActiva = false; var mensaje = ""; var claseCritica = false;
        lineaDistancia.clearLayers();
        const UMBRAL = 1000;

        zonasActivasAhora.forEach(zona => {
            var distCentro = map.distance(miPosicion, zona.center);
            var distBorde = distCentro - zona.radius;
            if (distBorde <= 0) {
                alertaActiva = true; claseCritica = true; mensaje = `‚õî ¬°PELIGRO!<br>EST√ÅS DENTRO DE: ${zona.name}`;
                L.polyline([miPosicion, zona.center], {color: 'red', weight: 4}).addTo(lineaDistancia);
            } else if (distBorde <= UMBRAL) {
                if (!claseCritica) {
                    alertaActiva = true; mensaje = `‚ö†Ô∏è PRECAUCI√ìN<br>A ${distBorde.toFixed(0)}m de: ${zona.name}`;
                    L.polyline([miPosicion, zona.center], {color: 'orange', dashArray: '5, 10'}).addTo(lineaDistancia);
                }
            }
        });
        if (alertaActiva) { box.style.display = "block"; box.innerHTML = mensaje; box.className = claseCritica ? "proximity-alert proximity-critical" : "proximity-alert"; }
        else { box.style.display = "none"; }
    }

    function chequearTormentas() {
        if (!miPosicion) return;
        var box = document.getElementById("storm-box");
        var detectados = [];
        sensores.forEach(s => { if (map.distance(miPosicion, [s.lat, s.lon]) < 5200) detectados.push(s.nombre); });
        if (detectados.length > 0) { box.style.display = "block"; box.innerHTML = `‚ö° EN SENSOR: <br>${detectados.join(" y ")}`; }
        else { box.style.display = "none"; }
    }

    window.onload = function() { actualizarTodo(); }
</script>
</body>
</html>