<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA GESTI√ìN TOROMOCHO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- ESTILOS BASE --- */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 1100; background: #2c3e50; color: white; border: none; border-radius: 4px; width: 40px; height: 40px; font-size: 1.5em; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        #panel { 
            position: absolute; top: 60px; left: 10px; width: 280px; 
            background: rgba(33, 47, 61, 0.95); color: white; padding: 10px; 
            border-radius: 8px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            max-height: 85vh; overflow-y: auto; transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }
        #panel.escondido { transform: translateX(-360%); }

        h4 { margin: 10px 0 5px 0; font-size: 0.8em; color: #2ecc71; text-transform: uppercase; text-align: center; border-bottom: 1px solid #555; padding-bottom: 5px; }
        
        button { width: 100%; padding: 12px; margin: 3px 0; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 0.75em; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        
        .btn-gps { background: #2980b9; color: white; }
        .btn-sync { background: #8e44ad; color: white; } 
        
        /* BOT√ìN REPORTE GENSETS (Naranja) */
        .btn-report { background: #d35400; color: white; border: 1px solid #e67e22; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        /* BOT√ìN ALERTA POSTES (Rojo Parpadeante) */
        .btn-alert { 
            background: #c0392b; color: white; 
            border: 2px solid #e74c3c; margin-bottom: 15px; 
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            animation: parpadeo-boton 1s infinite alternate; 
            display: none; 
        }
        @keyframes parpadeo-boton { from { opacity: 1; } to { opacity: 0.8; transform: scale(0.98); } }

        .tab-container { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .tab-btn { width: 48%; background: #34495e; color: #bdc3c7; border: 1px solid #555; padding: 8px; }
        .tab-btn.active { background: #16a085; color: white; border-color: #16a085; }

        .list-item { 
            background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 5px; 
            border-radius: 4px; font-size: 0.75em; border-left: 4px solid grey;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .list-item:hover { background: rgba(255,255,255,0.1); }
        .genset-item { border-left-color: #9b59b6; }

        .genset-marker { background: #8e44ad; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px black; display: flex; align-items: center; justify-content: center; }
        .genset-marker svg { width: 18px; height: 18px; fill: white; }
        .leaflet-popup-content { font-size: 1.1em; line-height: 1.4; }

        #radio-silence-alert { position: absolute; bottom: 30px; left: 20px; right: 20px; background: rgba(231, 76, 60, 0.95); color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: 900; font-size: 1.2em; z-index: 2000; border: 4px solid white; display: none; box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); text-transform: uppercase; animation: parpadeo-fuerte 0.8s infinite alternate; }
        @keyframes parpadeo-fuerte { from { opacity: 1; transform: scale(1); } to { opacity: 0.9; transform: scale(1.02); } }
        
        #reloj-sistema { font-family: monospace; color: #f1c40f; text-align: center; font-size: 1.2em; margin-bottom: 10px; border: 1px solid #555; padding: 5px; background: rgba(0,0,0,0.3); }
        .storm-alert { background: rgba(52, 152, 219, 0.2); border: 2px solid #3498db; color: #f1c40f; padding: 10px; margin-bottom: 10px; text-align: center; font-size: 0.8em; display: none; font-weight: bold; border-radius: 5px; }
        .proximity-alert { background: rgba(243, 156, 18, 0.2); border: 2px solid #f39c12; color: #e67e22; padding: 10px; margin-bottom: 10px; text-align: center; font-size: 0.9em; display: none; font-weight: bold; border-radius: 5px; animation: parpadeo-suave 1s infinite alternate; }
        .proximity-critical { background: rgba(231, 76, 60, 0.3); border: 2px solid #c0392b; color: #ff6b6b; }
        @keyframes parpadeo-suave { from { opacity: 0.8; } to { opacity: 1; } }

        .footer-dev { margin-top: 20px; padding-top: 10px; border-top: 1px solid #555; text-align: center; font-size: 0.6em; color: #95a5a6; }
        .car-icon { width: 30px; height: 30px; filter: drop-shadow(0px 0px 3px black); }
        .leaflet-control-layers { border-radius: 8px; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        #tabla-dinamica { width: 100%; border-collapse: collapse; font-size: 0.85em; color: #333; }
        #tabla-dinamica th { background: #2c3e50; color: white; padding: 10px; text-align: left; position: sticky; top: 0; }
        #tabla-dinamica td { padding: 8px; border-bottom: 1px solid #ddd; }
        #tabla-dinamica tr:nth-child(even) { background-color: #f2f2f2; }
        
        #btn-permiso { background: #16a085; font-size:0.7em; margin-bottom:10px; display:none; }
    </style>
</head>
<body>

<div id="radio-silence-alert">üö´ SILENCIO RADIAL ACTIVO üö´<br><span style="font-size:0.6em; font-weight:normal;">ZONA ROJA ACTIVADA</span></div>

<button id="menu-toggle" onclick="togglePanel()">‚ò∞</button>

<div id="panel">
    <div id="reloj-sistema">--:--:--</div>
    <button id="btn-permiso" onclick="pedirPermisoNotificaciones()">üîî ACTIVAR ALERTAS</button>

    <div id="storm-box" class="storm-alert"></div>
    <div id="proximity-box" class="proximity-alert"></div>

    <button id="btnGps" class="btn-gps" onclick="iniciarSeguimiento()">üìç MI UBICACI√ìN (GPS)</button>
    <div id="utm-display" style="text-align:center; font-size:0.7em; color:#f39c12; margin-bottom:10px; font-family:monospace;">...</div>

    <div class="tab-container">
        <button class="tab-btn active" onclick="cambiarTab('voladuras')" id="tab-vol">üí• Voladura</button>
        <button class="tab-btn" onclick="cambiarTab('gensets')" id="tab-gen">‚ö° Gensets</button>
    </div>

    <button class="btn-sync" onclick="actualizarTodo()">üîÑ ACTUALIZAR DATOS</button>

    <div id="view-voladuras">
        <button id="btn-interferencia" class="btn-alert" onclick="mostrarTablaInterferencias()">üö® VER POSTES AFECTADOS</button>
        
        <h4 style="color:#e74c3c">Programaci√≥n Hoy</h4>
        <div id="lista-voladuras"><em style="font-size:0.7em; color:#7f8c8d;">Cargando...</em></div>
    </div>

    <div id="view-gensets" style="display:none;">
        <button id="btn-reporte" class="btn-report" onclick="cargarReporteNativo()">üìÑ VER REPORTE T√âCNICO</button>
        <h4 style="color:#9b59b6">Generadores Activos</h4>
        <div id="lista-gensets"><em style="font-size:0.7em; color:#7f8c8d;">Sin datos...</em></div>
    </div>

    <div class="footer-dev">Dev: <b>Johann Handel CP</b></div>
</div>

<div id="modal-reporte" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; width:95%; height:85%; max-width:800px; border-radius:10px; overflow:hidden; position:relative; display:flex; flex-direction:column; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
        <div style="background:#2c3e50; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <span id="modal-titulo" style="font-weight:bold;">üìã REPORTE</span>
            <button onclick="cerrarReporte()" style="background:#e74c3c; border:none; color:white; font-weight:bold; width:30px; height:30px; border-radius:50%; cursor:pointer; font-size:16px;">X</button>
        </div>
        <div id="contenedor-tabla" style="overflow:auto; padding:0; height:100%; background:white;">
            <div style="padding:20px; text-align:center; color:grey;">Cargando...</div>
        </div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<script>
    // üîó ENLACES DE DATOS
    var LINK_VOLADURAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=0&single=true&output=csv";
    var LINK_GENSETS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=2066463473&single=true&output=csv"; 
    var LINK_REPORTE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=528288056&single=true&output=csv";

    // --- DATA: L√çNEAS EL√âCTRICAS ---
    var datosEnergia = {
      "type": "FeatureCollection", "features": [
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14465922206212, -11.62011178650611, 0 ] }, "properties": { "name": "P4:R1-DT" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14428380962211, -11.62026698905186, 0 ] }, "properties": { "name": "P3:R1-DT" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1433040590863, -11.62066871973589, 0 ] }, "properties": { "name": "P2A:R1-DT" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14262653066154, -11.62096074687278, 0 ] }, "properties": { "name": "P2:R1-DT" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14232426863526, -11.6210614055265, 0 ] }, "properties": { "name": "P1: A3" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14469550281946, -11.62001218101279, 0 ] }, "properties": { "name": "P1:THREE WAY-R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14467656883163, -11.61986758479612, 0 ] }, "properties": { "name": "P2:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1446477249793, -11.61954218871163, 0 ] }, "properties": { "name": "P3:S2" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14455202239223, -11.61856603674119, 0 ] }, "properties": { "name": "P4:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14479026382091, -11.61851083985542, 0 ] }, "properties": { "name": "P cable desconectado" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14544093368166, -11.61838167018113, 0 ] }, "properties": { "name": "P" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14457621606408, -11.61775216436268, 0 ] }, "properties": { "name": "P5 Secc: A3" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14467723325002, -11.62003033741706, 0 ] }, "properties": { "name": "110 DS 008" } },
        { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [ [ -76.14465967833841, -11.620110047178, 0 ], [ -76.14468927369262, -11.6200094440963, 0 ], [ -76.14467412511539, -11.61986020429342, 0 ], [ -76.14464149422271, -11.61953591251048, 0 ], [ -76.14455019660471, -11.61855546116685, 0 ], [ -76.14457664261761, -11.61774999429316, 0 ] ] }, "properties": { "name": "Drv. Antiguo Truck Shop" } },
        { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [ [ -76.14232346476558, -11.62105793403807, 0 ], [ -76.14262829939479, -11.62095693847417, 0 ], [ -76.1433048131181, -11.6206644638621, 0 ], [ -76.14428220026711, -11.62026397178024, 0 ], [ -76.14465905620234, -11.62010643452295, 0 ] ] }, "properties": { "name": "Anillo Mina C1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1423241212759, -11.62102523825032, 0 ] }, "properties": { "name": "P1:A3" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14262605162297, -11.62084320323646, 0 ] }, "properties": { "name": "P2:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14294625128935, -11.62064301163397, 0 ] }, "properties": { "name": "P3:S0" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14347651493917, -11.62022498009887, 0 ] }, "properties": { "name": "P4:A1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14348295800886, -11.61955584935576, 0 ] }, "properties": { "name": "P5:A2" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14241782658176, -11.61926168397149, 0 ] }, "properties": { "name": "T6:S0-3C" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14117817766157, -11.61890491095095, 0 ] }, "properties": { "name": "T7:S0-3C" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.14017864903327, -11.61895407232934, 0 ] }, "properties": { "name": "P6:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13899609006498, -11.61910341459283, 0 ] }, "properties": { "name": "P7:R1-PIN" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1379139777117, -11.61914385223756, 0 ] }, "properties": { "name": "P8:DOS POSTES-R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13703918409898, -11.61828831272705, 0 ] }, "properties": { "name": "P-9:DOS POSTES-R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13468062847653, -11.61567542016587, 0 ] }, "properties": { "name": "P13:S0+1 LP" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1359706194426, -11.61714418935629, 0 ] }, "properties": { "name": "P10:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1357862714104, -11.61691886532479, 0 ] }, "properties": { "name": "P11:S0" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13522431369202, -11.61630622132517, 0 ] }, "properties": { "name": "P12:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13453326136785, -11.61552228566654, 0 ] }, "properties": { "name": "P14:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13430294802569, -11.61527001517086, 0 ] }, "properties": { "name": "T15:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13235371916409, -11.61407508359791, 0 ] }, "properties": { "name": "P16:DOS POSTES-R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13130462644155, -11.61320212313534, 0 ] }, "properties": { "name": "P17:THREE WAY-R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1305410950798, -11.61263546820796, 0 ] }, "properties": { "name": "P18:A1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1300143138945, -11.61164291007835, 0 ] }, "properties": { "name": "P19:A2" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.12991568190249, -11.60992531478466, 0 ] }, "properties": { "name": "P20:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.12985730454767, -11.60909367849066, 0 ] }, "properties": { "name": "P21:A2*" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.12962165172124, -11.60751224880765, 0 ] }, "properties": { "name": "P22:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.12951800196517, -11.6068254614223, 0 ] }, "properties": { "name": "P23:A2*" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.1294420122573, -11.60617473380813, 0 ] }, "properties": { "name": "P24:A1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.12971536820157, -11.60573060624014, 0 ] }, "properties": { "name": "P25:R1+2 PIN" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13049052146798, -11.60463349037963, 0 ] }, "properties": { "name": "P26:A1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13094975819574, -11.60434235573836, 0 ] }, "properties": { "name": "P27:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13124063231257, -11.60415132746171, 0 ] }, "properties": { "name": "P28:R1-PIN" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13142354667058, -11.60402402302477, 0 ] }, "properties": { "name": "P29:R1-PIN" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13162338216436, -11.60354401395574, 0 ] }, "properties": { "name": "P30:R1*+SECC" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13168677888756, -11.60334484147906, 0 ] }, "properties": { "name": "P31:S2*" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13166683320765, -11.60294707132232, 0 ] }, "properties": { "name": "P32:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13161857257168, -11.6023504878965, 0 ] }, "properties": { "name": "P33:S0-1C" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13155036707604, -11.60135613418573, 0 ] }, "properties": { "name": "P34:A1*" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.13172454566195, -11.60133736801021, 0 ] }, "properties": { "name": "P35:A2" } },
        { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [ [ -76.14232243002964, -11.62101788009237, 0 ], [ -76.14262816789747, -11.62083937577406, 0 ], [ -76.14295048827718, -11.62063778566179, 0 ], [ -76.14347810712016, -11.62021936332017, 0 ], [ -76.14348529261056, -11.61954696892582, 0 ], [ -76.14241716385524, -11.61925800797873, 0 ], [ -76.14117745382681, -11.61889723438726, 0 ], [ -76.14017912506424, -11.61894787953184, 0 ], [ -76.13899519333019, -11.61909741277658, 0 ], [ -76.13791487509232, -11.61913773370697, 0 ], [ -76.137034605834, -11.61828360618312, 0 ], [ -76.1359685883636, -11.6171297162255, 0 ], [ -76.13578864011846, -11.61691339089228, 0 ], [ -76.1352246178304, -11.61629599275212, 0 ], [ -76.13466998336904, -11.61566702485515, 0 ], [ -76.13453494654989, -11.61551616373398, 0 ], [ -76.13430130694962, -11.61526836185344, 0 ], [ -76.13235087843216, -11.61407478910492, 0 ], [ -76.13130085427515, -11.61319606838499, 0 ], [ -76.13054438315093, -11.61263010714936, 0 ], [ -76.13001122578194, -11.61164361103586, 0 ], [ -76.12991074256459, -11.60991837489728, 0 ], [ -76.12985517543586, -11.60908491592153, 0 ], [ -76.12961819643117, -11.60750350103111, 0 ], [ -76.12951910179723, -11.60682163969981, 0 ], [ -76.12944226884845, -11.60616771719789, 0 ], [ -76.12971724565614, -11.60572828987408, 0 ], [ -76.13048851811374, -11.60462411582702, 0 ], [ -76.13094975819574, -11.60433978163304, 0 ], [ -76.13124068848732, -11.60414876537653, 0 ], [ -76.13142179047836, -11.60402171775137, 0 ], [ -76.13162242604226, -11.60354357411542, 0 ], [ -76.13168587566885, -11.60334447852337, 0 ], [ -76.13166645642411, -11.60294843772323, 0 ], [ -76.13161672644422, -11.60234984841893, 0 ], [ -76.1315492400745, -11.60135552313515, 0 ], [ -76.13172482209501, -11.60133632900435, 0 ], [ -76.13206130035621, -11.60093631450834, 0 ] ] }, "properties": { "name": "L.3", "stroke": "#ffff00" } },
        { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [ [ -76.15424372829537, -11.61404305687519, 0 ], [ -76.15494384739594, -11.61302138012434, 0 ], [ -76.15381312655518, -11.61298898320669, 0 ] ] }, "properties": { "name": "L.4", "stroke": "#ffff00" } }
      ]
    };

    function togglePanel() { document.getElementById('panel').classList.toggle('escondido'); }
    
    function cambiarTab(tab) {
        document.getElementById('view-voladuras').style.display = (tab === 'voladuras') ? 'block' : 'none';
        document.getElementById('view-gensets').style.display = (tab === 'gensets') ? 'block' : 'none';
        document.getElementById('tab-vol').className = (tab === 'voladuras') ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-gen').className = (tab === 'gensets') ? 'tab-btn active' : 'tab-btn';
    }

    // --- REPORTE GEN√âRICO (Sirve para Gensets y Postes) ---
    function mostrarReporteGenerico(titulo, filas) {
        var modal = document.getElementById('modal-reporte');
        var contenedor = document.getElementById('contenedor-tabla');
        var tituloSpan = document.getElementById('modal-titulo');
        
        tituloSpan.innerText = titulo;
        modal.style.display = "flex";
        
        let htmlTabla = '<table id="tabla-dinamica"><tr><th>DETALLE</th><th>ESTADO</th></tr>';
        filas.forEach(f => {
            htmlTabla += `<tr><td>${f.nombre}</td><td>${f.estado}</td></tr>`;
        });
        htmlTabla += '</table>';
        contenedor.innerHTML = htmlTabla;
    }

    async function cargarReporteNativo() { // Para Gensets (desde CSV)
        var modal = document.getElementById('modal-reporte');
        var contenedor = document.getElementById('contenedor-tabla');
        var tituloSpan = document.getElementById('modal-titulo');
        
        tituloSpan.innerText = "üìã REPORTE T√âCNICO";
        modal.style.display = "flex";
        contenedor.innerHTML = '<div style="padding:20px; text-align:center; color:grey;">‚è≥ Descargando datos...</div>';

        try {
            const response = await fetch(LINK_REPORTE_CSV + '&t=' + Date.now());
            const text = await response.text();
            const filas = text.split('\n');
            let htmlTabla = '<table id="tabla-dinamica">';
            for (let i = 0; i < filas.length; i++) {
                if(filas[i].trim() === "") continue;
                var celdas = filas[i].split(',');
                htmlTabla += '<tr>';
                for (let j = 0; j < celdas.length; j++) {
                    var tag = (i === 0) ? 'th' : 'td';
                    htmlTabla += `<${tag}>${celdas[j]}</${tag}>`;
                }
                htmlTabla += '</tr>';
            }
            htmlTabla += '</table>';
            contenedor.innerHTML = htmlTabla;
        } catch (error) {
            contenedor.innerHTML = '<div style="padding:20px; text-align:center; color:red;">‚ùå Error al cargar reporte.</div>';
        }
    }

    function cerrarReporte() {
        document.getElementById('modal-reporte').style.display = "none";
    }

    setInterval(() => {
        document.getElementById("reloj-sistema").innerText = new Date().toLocaleTimeString('es-PE', { hour12: false });
    }, 1000);

    proj4.defs("EPSG:32718", "+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
    var map = L.map('map', { zoomControl: false }).setView([-11.619, -76.08], 13);

    var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
    var mapaPlano = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
    var mapaTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'OTM' });

    mapaSatelite.addTo(map);
    
    var capaVoladuras = L.layerGroup().addTo(map);
    var capaGensets = L.layerGroup().addTo(map);
    var capaGPS = L.layerGroup().addTo(map);
    var capaTormentas = L.layerGroup().addTo(map);
    var lineaDistancia = L.layerGroup().addTo(map);

    // --- ESTILOS "FANTASMA" (Casi invisibles) ---
    function estiloEnergia(feature) {
        var colorLinea = feature.properties.stroke || "#f1c40f"; 
        return { color: colorLinea, weight: 2, opacity: 0.3, dashArray: '5, 5' };
    }
    function estiloPuntos(feature, latlng) {
        return L.circleMarker(latlng, { radius: 3, fillColor: "#00ffff", color: "#000", weight: 1, opacity: 0.3, fillOpacity: 0.3 });
    }

    var capaEnergia = L.geoJSON(datosEnergia, {
        style: estiloEnergia,
        pointToLayer: estiloPuntos,
        onEachFeature: function (feature, layer) {
            if (feature.properties && feature.properties.name) {
                layer.bindPopup("üîå <b>" + feature.properties.name + "</b>");
            }
        }
    }).addTo(map);

    L.control.layers(
        { "üåé Sat√©lite": mapaSatelite, "üó∫Ô∏è Plano": mapaPlano, "‚õ∞Ô∏è Topogr√°fico": mapaTopo }, 
        { "‚ö° Sensores": capaTormentas, "üí• Voladuras": capaVoladuras, "üü£ Gensets": capaGensets, "üîå L√≠neas El√©ctricas": capaEnergia }, 
        { position: 'topright' }
    ).addTo(map);

    const sensores = [
        { nombre: "MINA", lat: -11.61543, lon: -76.14331 },
        { nombre: "CARHUACOTO", lat: -11.58529, lon: -76.06169 },
        { nombre: "TUNSHURUCO", lat: -11.67360, lon: -76.13777 },
        { nombre: "KINGSMILL", lat: -11.63342, lon: -76.05691 }
    ];
    sensores.forEach(s => {
        L.marker([s.lat, s.lon], {icon: L.divIcon({html:'‚ö°', className:''})}).addTo(capaTormentas);
        L.circle([s.lat, s.lon], {radius: 5200, color:'#3498db', fillColor:'#3498db', fillOpacity:0.15, weight:1}).addTo(capaTormentas);
    });

    var zonasProgramadas = [];
    var zonasActivasAhora = []; 
    var postesAfectados = []; // Lista para guardar los afectados
    var intervaloChequeo = null;

    function actualizarTodo() {
        cargarVoladuras();
        cargarGensets();
    }

    async function cargarVoladuras() {
        var btn = document.querySelector(".btn-sync");
        btn.innerHTML = "‚è≥ CARGANDO...";
        try {
            const response = await fetch(LINK_VOLADURAS + '&t=' + Date.now());
            const text = await response.text();
            zonasProgramadas = [];
            const filas = text.split('\n');
            for (let i = 1; i < filas.length; i++) {
                const col = filas[i].split(',');
                if (col.length >= 6 && col[0].trim() !== "") {
                    zonasProgramadas.push({
                        n: parseFloat(col[0]), e: parseFloat(col[1]), r: parseFloat(col[2]),
                        detalle: col[3], hora: col[4].trim(), dur: parseInt(col[5])
                    });
                }
            }
            if (intervaloChequeo) clearInterval(intervaloChequeo);
            actualizarMapaSegunHora();
            intervaloChequeo = setInterval(actualizarMapaSegunHora, 1000);
            btn.innerHTML = "‚úÖ LISTO"; setTimeout(() => { btn.innerHTML = "üîÑ ACTUALIZAR DATOS"; }, 3000);
        } catch (err) { console.error(err); btn.innerHTML = "‚ùå ERROR VOL"; }
    }

    async function cargarGensets() {
        if (!LINK_GENSETS.startsWith("http")) return; 
        try {
            const response = await fetch(LINK_GENSETS + '&t=' + Date.now());
            const text = await response.text();
            const filas = text.split('\n');
            capaGensets.clearLayers();
            const listaDiv = document.getElementById("lista-gensets");
            listaDiv.innerHTML = "";

            for (let i = 1; i < filas.length; i++) {
                const col = filas[i].split(',');
                if (col.length >= 4 && col[0].trim() !== "") {
                    const n = parseFloat(col[0]);
                    const e = parseFloat(col[1]);
                    const nombre = col[2];
                    const estado = col[3] ? col[3].trim().toUpperCase() : "";
                    const lugar = col[4] || "Sin datos";
                    const horas = col[5] || "-";
                    const tension = col[6] || "-";

                    if (estado.includes("TRABAJANDO") && !isNaN(n)) {
                        try {
                            const c = proj4("EPSG:32718", "EPSG:4326", [e, n]);
                            const lat = c[1]; const lon = c[0];
                            const iconoGenset = L.divIcon({
                                className: 'genset-marker',
                                html: `<svg viewBox="0 0 24 24"><path d="M4 6h16v10H4z"/><path d="M6 8h12v6H6z" fill="#8e44ad"/><path d="M7 9h3v4H7zm4 0h3v4h-3zm4 0h3v4h-3z" fill="white"/><path d="M5 16v3h2v-3m10 0v3h2v-3" stroke="white" stroke-width="2"/></svg>`,
                                iconSize: [28, 28], iconAnchor: [14, 14]
                            });
                            const popupContent = `<div style="min-width:180px;"><h3 style="margin:0; color:#8e44ad;">${nombre}</h3><table class="tabla-info"><tr><td>Estado:</td><td>${estado}</td></tr><tr><td>Lugar:</td><td>${lugar}</td></tr><tr><td>Coord:</td><td><small>${n}, ${e}</small></td></tr></table></div>`;
                            L.marker([lat, lon], {icon: iconoGenset}).bindPopup(popupContent).addTo(capaGensets);
                            listaDiv.innerHTML += `<div class="list-item genset-item" onclick="viajarA(${lat}, ${lon})"><div><strong>${nombre}</strong><br><small>${lugar}</small></div><div style="font-size:1.2em; color:#8e44ad">‚ö°</div></div>`;
                        } catch(e) {}
                    }
                }
            }
            if (listaDiv.innerHTML === "") listaDiv.innerHTML = "<div style='text-align:center;color:grey'>No hay gensets activos.</div>";
        } catch (err) { console.error("Error Gensets", err); }
    }

    window.viajarA = function(lat, lon) {
        map.flyTo([lat, lon], 18);
        if (window.innerWidth < 600) togglePanel();
    };

    function actualizarMapaSegunHora() {
        const ahora = new Date();
        const listaDiv = document.getElementById("lista-voladuras");
        const alertaDiv = document.getElementById("radio-silence-alert");
        listaDiv.innerHTML = ""; capaVoladuras.clearLayers(); 
        let haySilencioRadial = false; zonasActivasAhora = [];

        zonasProgramadas.forEach(zona => {
            if (!zona.hora) return;
            const [hh, mm] = zona.hora.split(':');
            const fechaInicio = new Date(); fechaInicio.setHours(hh, mm, 0);
            const fechaFin = new Date(fechaInicio.getTime() + zona.dur * 60000);
            let estadoTexto = ""; let colorBorde = ""; let colorMapa = ""; let dibujar = false; let esPeligroso = false;

            if (ahora > fechaFin) {
                estadoTexto = "FINALIZADO"; colorBorde = "#7f8c8d";
            } else if (ahora >= fechaInicio && ahora <= fechaFin) {
                estadoTexto = "üö® EN EJECUCI√ìN"; colorBorde = "#e74c3c"; colorMapa = "red"; dibujar = true; haySilencioRadial = true; esPeligroso = true;
            } else {
                estadoTexto = "‚è≥ PROGRAMADO"; colorBorde = "#f39c12"; colorMapa = "orange"; dibujar = true; esPeligroso = true;
            }

            if (dibujar && !isNaN(zona.n)) {
                try {
                    const c = proj4("EPSG:32718", "EPSG:4326", [zona.e, zona.n]);
                    // IMPORTANTE: Agregamos tanto ROJAS como NARANJAS a la lista de chequeo
                    if (esPeligroso) zonasActivasAhora.push({ center: L.latLng(c[1], c[0]), radius: zona.r, name: zona.detalle, type: colorMapa });
                    const colorHex = (colorMapa === "red") ? "#e74c3c" : "#f39c12";
                    const opacidad = (colorMapa === "red") ? 0.5 : 0.2;
                    L.circle([c[1], c[0]], { radius: zona.r, color: colorHex, fillColor: colorHex, fillOpacity: opacidad, weight: 2 }).bindPopup(`<b>${zona.detalle}</b><br>${zona.hora}`).addTo(capaVoladuras);
                } catch(e) {}
            }

            if (estadoTexto !== "FINALIZADO" || (ahora - fechaFin) < 7200000) {
                listaDiv.innerHTML += `<div class="list-item" style="border-left-color: ${colorBorde};"><div><strong style="font-size:1.1em">${zona.detalle}</strong><br><span style="color:${colorBorde}; font-weight:bold;">${estadoTexto}</span></div><div style="text-align:right;">${zona.hora}<br><small>${zona.dur} min</small></div></div>`;
            }
        });

        alertaDiv.style.display = haySilencioRadial ? "block" : "none";
        if (listaDiv.innerHTML === "") listaDiv.innerHTML = "<div style='text-align:center; padding:10px; color:#7f8c8d;'>Sin voladuras pendientes.</div>";
        
        if (miPosicion) chequearProximidadVoladura();
        
        // Ejecutar detector
        verificarInterferencias(); 
    }

    // --- DETECTOR DE INTERFERENCIAS (Sin cambio de tama√±o) ---
    function verificarInterferencias() {
        postesAfectados = []; // Resetear lista de reportes

        // 1. Resetear todo a fantasma
        capaEnergia.eachLayer(function(layer) {
            if (layer instanceof L.CircleMarker) { 
                layer.setStyle({ fillColor: "#00ffff", color: "#000", radius: 3, opacity: 0.3, fillOpacity: 0.3 }); 
            } else if (layer instanceof L.Polyline) { 
                layer.setStyle({ color: layer.feature.properties.stroke || "#f1c40f", weight: 2, dashArray: '5, 5', opacity: 0.3 });
            }
        });

        if (zonasActivasAhora.length === 0) {
            document.getElementById('btn-interferencia').style.display = 'none';
            return;
        }

        // 2. Buscar conflictos
        zonasActivasAhora.forEach(zona => {
            capaEnergia.eachLayer(function(layer) {
                let afectado = false;
                // Puntos
                if (layer instanceof L.CircleMarker) {
                    if (map.distance(layer.getLatLng(), zona.center) <= zona.radius) afectado = true;
                }
                // L√≠neas
                else if (layer instanceof L.Polyline) {
                    let puntos = layer.getLatLngs().flat ? layer.getLatLngs().flat(99) : layer.getLatLngs(); 
                    for (let p of puntos) {
                        if (map.distance(p, zona.center) <= zona.radius) { afectado = true; break; }
                    }
                }

                if (afectado) {
                    postesAfectados.push({
                        nombre: layer.feature.properties.name || "Sin Nombre",
                        estado: "‚ö†Ô∏è " + zona.name
                    });

                    // Pintar ROJO INTENSO (Mismo tama√±o)
                    if (layer instanceof L.CircleMarker) {
                        layer.setStyle({ fillColor: "red", color: "white", radius: 3, weight: 2, opacity: 1, fillOpacity: 1 });
                        layer.bindPopup("üö® <b>¬°AFECTADO!</b><br>" + (layer.feature.properties.name || "Sin nombre"));
                    } else {
                        layer.setStyle({ color: "red", weight: 4, dashArray: null, opacity: 1 });
                    }
                }
            });
        });

        // 3. Mostrar bot√≥n si hay problemas
        var btnAlert = document.getElementById('btn-interferencia');
        if (postesAfectados.length > 0) {
            btnAlert.style.display = 'block';
            btnAlert.innerText = `üö® VER ${postesAfectados.length} POSTES AFECTADOS`;
            enviarNotificacion("ALERTA", `Se detectaron ${postesAfectados.length} interferencias.`);
        } else {
            btnAlert.style.display = 'none';
        }
    }

    function mostrarTablaInterferencias() {
        mostrarReporteGenerico("‚ö†Ô∏è POSTES AFECTADOS", postesAfectados);
    }

    // --- NOTIFICACIONES ---
    var notificacionEnviada = false;
    function pedirPermisoNotificaciones() {
        if (!("Notification" in window)) alert("No soportado");
        else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(function (p) {
                if (p === "granted") {
                    alert("Notificaciones Activadas");
                    document.getElementById('btn-permiso').style.display = 'none';
                }
            });
        }
    }
    function enviarNotificacion(t, c) {
        if (Notification.permission === "granted" && !notificacionEnviada) {
            new Notification("üö® ALERTA TOROMOCHO", { body: t + ": " + c });
            notificacionEnviada = true; setTimeout(() => { notificacionEnviada = false; }, 300000); 
        }
    }
    if (Notification.permission !== "granted" && "Notification" in window) document.getElementById('btn-permiso').style.display = 'block';

    // --- GPS ---
    var truckIcon = L.divIcon({ className: 'car-container', html: `<svg class="car-icon" viewBox="0 0 24 24" fill="#00FF00" xmlns="http://www.w3.org/2000/svg"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5H6.5C5.84 5 5.28 5.42 5.08 6.01L3 12V20C3 20.55 3.45 21 4 21H5C5.55 21 6 20.55 6 20V19H18V20C18 20.55 18.45 21 19 21H20C20.55 21 21 20.55 21 20V12L18.92 6.01ZM6.5 16C5.67 16 5 15.33 5 14.5C5 13.67 5.67 13 6.5 13C7.33 13 8 13.67 8 14.5C8 15.33 7.33 16 6.5 16ZM17.5 16C16.67 16 16 15.33 16 14.5C16 13.67 16.67 13 17.5 13C18.33 13 19 13.67 19 14.5C19 15.33 18.33 16 17.5 16ZM5 11L6.5 6.5H17.5L19 11H5Z"/></svg>`, iconSize: [30, 30], iconAnchor: [15, 15] });
    var marcadorVehiculo = null;
    var miPosicion = null;

    function iniciarSeguimiento() {
        var btn = document.getElementById("btnGps");
        if (!navigator.geolocation) { alert("Sin GPS"); return; }
        btn.innerHTML = "üîÑ BUSCANDO..."; btn.style.backgroundColor = "#e67e22";
        navigator.geolocation.watchPosition((pos) => {
            var lat = pos.coords.latitude; var lon = pos.coords.longitude;
            miPosicion = L.latLng(lat, lon);
            try {
                var utm = proj4("EPSG:4326", "EPSG:32718", [lon, lat]);
                document.getElementById("utm-display").innerHTML = `N: ${utm[1].toFixed(0)} | E: ${utm[0].toFixed(0)}`;
            } catch(e) {}
            btn.innerHTML = "‚úÖ GPS ACTIVO"; btn.style.backgroundColor = "#27ae60";
            if (!marcadorVehiculo) { marcadorVehiculo = L.marker([lat, lon], {icon: truckIcon}).addTo(capaGPS); map.flyTo([lat, lon], 16); }
            else { marcadorVehiculo.setLatLng([lat, lon]); }
            chequearTormentas(); chequearProximidadVoladura();
        }, (err) => { btn.innerHTML = "‚ö†Ô∏è SIN SE√ëAL"; btn.style.backgroundColor = "#c0392b"; }, { enableHighAccuracy: true });
    }

    function chequearProximidadVoladura() {
        if (!miPosicion || zonasActivasAhora.length === 0) { document.getElementById("proximity-box").style.display = "none"; return; }
        var box = document.getElementById("proximity-box");
        var alertaActiva = false; var mensaje = ""; var claseCritica = false;
        lineaDistancia.clearLayers();
        const UMBRAL = 1000;

        zonasActivasAhora.forEach(zona => {
            var distCentro = map.distance(miPosicion, zona.center);
            var distBorde = distCentro - zona.radius;
            if (distBorde <= 0) {
                alertaActiva = true; claseCritica = true; mensaje = `‚õî ¬°PELIGRO!<br>EST√ÅS DENTRO DE: ${zona.name}`;
                L.polyline([miPosicion, zona.center], {color: 'red', weight: 4}).addTo(lineaDistancia);
                enviarNotificacion("PELIGRO PERSONAL", "Usted est√° DENTRO de zona de voladura");
            } else if (distBorde <= UMBRAL) {
                if (!claseCritica) {
                    alertaActiva = true; mensaje = `‚ö†Ô∏è PRECAUCI√ìN<br>A ${distBorde.toFixed(0)}m de: ${zona.name}`;
                    L.polyline([miPosicion, zona.center], {color: 'orange', dashArray: '5, 10'}).addTo(lineaDistancia);
                }
            }
        });
        if (alertaActiva) { box.style.display = "block"; box.innerHTML = mensaje; box.className = claseCritica ? "proximity-alert proximity-critical" : "proximity-alert"; }
        else { box.style.display = "none"; }
    }

    function chequearTormentas() {
        if (!miPosicion) return;
        var box = document.getElementById("storm-box");
        var detectados = [];
        sensores.forEach(s => { if (map.distance(miPosicion, [s.lat, s.lon]) < 5200) detectados.push(s.nombre); });
        if (detectados.length > 0) { box.style.display = "block"; box.innerHTML = `‚ö° EN SENSOR: <br>${detectados.join(" y ")}`; }
        else { box.style.display = "none"; }
    }

    window.onload = function() { actualizarTodo(); }
</script>
</body>
</html>