<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA GESTI√ìN TOROMOCHO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- ESTILOS --- */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 1100; background: #2c3e50; color: white; border: none; border-radius: 4px; width: 40px; height: 40px; font-size: 1.5em; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        #panel { 
            position: absolute; top: 60px; left: 10px; width: 280px; 
            background: rgba(33, 47, 61, 0.95); color: white; padding: 10px; 
            border-radius: 8px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            max-height: 85vh; overflow-y: auto; transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }
        #panel.escondido { transform: translateX(-360%); }

        h4 { margin: 10px 0 5px 0; font-size: 0.8em; color: #2ecc71; text-transform: uppercase; text-align: center; border-bottom: 1px solid #555; padding-bottom: 5px; }
        
        button { width: 100%; padding: 12px; margin: 3px 0; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 0.75em; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        
        .btn-gps { background: #2980b9; color: white; }
        .btn-sync { background: #8e44ad; color: white; } 
        .btn-report { background: #d35400; color: white; border: 1px solid #e67e22; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        /* BOT√ìN ALERTA POSTES (ROJO) */
        .btn-alert { 
            background: #c0392b; color: white; 
            border: 2px solid #e74c3c; margin-bottom: 15px; 
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.6);
            animation: parpadeo-boton 1s infinite alternate; 
            display: none; 
        }
        @keyframes parpadeo-boton { from { opacity: 1; transform: scale(1); } to { opacity: 0.9; transform: scale(0.98); } }

        .tab-container { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .tab-btn { width: 48%; background: #34495e; color: #bdc3c7; border: 1px solid #555; padding: 8px; }
        .tab-btn.active { background: #16a085; color: white; border-color: #16a085; }

        .list-item { background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.75em; border-left: 4px solid grey; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .list-item:hover { background: rgba(255,255,255,0.1); }
        .genset-item { border-left-color: #9b59b6; }

        .genset-marker { background: #8e44ad; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px black; display: flex; align-items: center; justify-content: center; }
        .genset-marker svg { width: 18px; height: 18px; fill: white; }
        .leaflet-popup-content { font-size: 1.1em; line-height: 1.4; }

        #radio-silence-alert { position: absolute; bottom: 30px; left: 20px; right: 20px; background: rgba(231, 76, 60, 0.95); color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: 900; font-size: 1.2em; z-index: 2000; border: 4px solid white; display: none; box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); text-transform: uppercase; animation: parpadeo-fuerte 0.8s infinite alternate; }
        @keyframes parpadeo-fuerte { from { opacity: 1; transform: scale(1); } to { opacity: 0.9; transform: scale(1.02); } }
        
        #reloj-sistema { font-family: monospace; color: #f1c40f; text-align: center; font-size: 1.2em; margin-bottom: 10px; border: 1px solid #555; padding: 5px; background: rgba(0,0,0,0.3); }
        .storm-alert { background: rgba(52, 152, 219, 0.2); border: 2px solid #3498db; color: #f1c40f; padding: 10px; margin-bottom: 10px; text-align: center; font-size: 0.8em; display: none; font-weight: bold; border-radius: 5px; }
        .proximity-alert { background: rgba(243, 156, 18, 0.2); border: 2px solid #f39c12; color: #e67e22; padding: 10px; margin-bottom: 10px; text-align: center; font-size: 0.9em; display: none; font-weight: bold; border-radius: 5px; animation: parpadeo-suave 1s infinite alternate; }
        .proximity-critical { background: rgba(231, 76, 60, 0.3); border: 2px solid #c0392b; color: #ff6b6b; }
        @keyframes parpadeo-suave { from { opacity: 0.8; } to { opacity: 1; } }

        .footer-dev { margin-top: 20px; padding-top: 10px; border-top: 1px solid #555; text-align: center; font-size: 0.6em; color: #95a5a6; }
        .car-icon { width: 30px; height: 30px; filter: drop-shadow(0px 0px 3px black); }
        .leaflet-control-layers { border-radius: 8px; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        #tabla-dinamica { width: 100%; border-collapse: collapse; font-size: 0.85em; color: #333; }
        #tabla-dinamica th { background: #2c3e50; color: white; padding: 10px; text-align: left; position: sticky; top: 0; }
        #tabla-dinamica td { padding: 8px; border-bottom: 1px solid #ddd; }
        #tabla-dinamica tr:nth-child(even) { background-color: #f2f2f2; }
        
        #btn-permiso { background: #16a085; font-size:0.7em; margin-bottom:10px; display:none; }
    </style>
</head>
<body>

<div id="radio-silence-alert">üö´ SILENCIO RADIAL ACTIVO üö´<br><span style="font-size:0.6em; font-weight:normal;">ZONA ROJA ACTIVADA</span></div>

<button id="menu-toggle" onclick="togglePanel()">‚ò∞</button>

<div id="panel">
    <div id="reloj-sistema">--:--:--</div>
    <button id="btn-permiso" onclick="pedirPermisoNotificaciones()">üîî ACTIVAR ALERTAS</button>

    <div id="storm-box" class="storm-alert"></div>
    <div id="proximity-box" class="proximity-alert"></div>

    <button id="btnGps" class="btn-gps" onclick="iniciarSeguimiento()">üìç MI UBICACI√ìN (GPS)</button>
    <div id="utm-display" style="text-align:center; font-size:0.7em; color:#f39c12; margin-bottom:10px; font-family:monospace;">...</div>

    <div class="tab-container">
        <button class="tab-btn active" onclick="cambiarTab('voladuras')" id="tab-vol">üí• Voladura</button>
        <button class="tab-btn" onclick="cambiarTab('gensets')" id="tab-gen">‚ö° Gensets</button>
    </div>

    <button class="btn-sync" onclick="actualizarTodo()">üîÑ ACTUALIZAR DATOS</button>

    <div id="view-voladuras">
        <button id="btn-interferencia" class="btn-alert" onclick="mostrarTablaInterferencias()">üö® VER POSTES AFECTADOS</button>
        <h4 style="color:#e74c3c">Programaci√≥n Hoy</h4>
        <div id="lista-voladuras"><em style="font-size:0.7em; color:#7f8c8d;">Cargando...</em></div>
    </div>

    <div id="view-gensets" style="display:none;">
        <button id="btn-reporte" class="btn-report" onclick="cargarReporteNativo()">üìÑ VER REPORTE T√âCNICO</button>
        <h4 style="color:#9b59b6">Generadores Activos</h4>
        <div id="lista-gensets"><em style="font-size:0.7em; color:#7f8c8d;">Sin datos...</em></div>
    </div>

    <div class="footer-dev">Dev: <b>Johann Handel CP</b></div>
</div>

<div id="modal-reporte" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; width:95%; height:85%; max-width:800px; border-radius:10px; overflow:hidden; position:relative; display:flex; flex-direction:column; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
        <div style="background:#2c3e50; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <span id="modal-titulo" style="font-weight:bold;">üìã REPORTE</span>
            <button onclick="cerrarReporte()" style="background:#e74c3c; border:none; color:white; font-weight:bold; width:30px; height:30px; border-radius:50%; cursor:pointer; font-size:16px;">X</button>
        </div>
        <div id="contenedor-tabla" style="overflow:auto; padding:0; height:100%; background:white;">
            <div style="padding:20px; text-align:center; color:grey;">Cargando...</div>
        </div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<script>
    var LINK_VOLADURAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=0&single=true&output=csv";
    var LINK_GENSETS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=2066463473&single=true&output=csv"; 
    var LINK_REPORTE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=528288056&single=true&output=csv";

    // --- DATA CORREGIDA (Ya no est√° anidada) ---
    var datosEnergia = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.144659, -11.620111 ] }, "properties": { "name": "P4:R1-DT" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.144283, -11.620266 ] }, "properties": { "name": "P3:R1-DT" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.143304, -11.620668 ] }, "properties": { "name": "P2A:R1-DT" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.142626, -11.620960 ] }, "properties": { "name": "P2:R1-DT" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.142324, -11.621061 ] }, "properties": { "name": "P1: A3" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.144695, -11.620012 ] }, "properties": { "name": "P1:THREE WAY" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.144676, -11.619867 ] }, "properties": { "name": "P2:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.144647, -11.619542 ] }, "properties": { "name": "P3:S2" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.144552, -11.618566 ] }, "properties": { "name": "P4:R1" } },
        { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[-76.144659,-11.620110], [-76.144689,-11.620009], [-76.144674,-11.619860], [-76.144641,-11.619535], [-76.144550,-11.618555], [-76.144576,-11.617749]] }, "properties": { "name": "Drv. Antiguo Truck Shop", "stroke": "#ffff00" } },
        { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[-76.142323,-11.621057], [-76.142628,-11.620956], [-76.143304,-11.620664], [-76.144282,-11.620263], [-76.144659,-11.620106]] }, "properties": { "name": "Anillo Mina C1", "stroke": "#55ffff" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.142324, -11.621025 ] }, "properties": { "name": "P1:A3" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.142626, -11.620843 ] }, "properties": { "name": "P2:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.142946, -11.620643 ] }, "properties": { "name": "P3:S0" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.143476, -11.620224 ] }, "properties": { "name": "P4:A1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.143482, -11.619555 ] }, "properties": { "name": "P5:A2" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.142417, -11.619261 ] }, "properties": { "name": "T6:S0-3C" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.141178, -11.618904 ] }, "properties": { "name": "T7:S0-3C" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.140178, -11.618954 ] }, "properties": { "name": "P6:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.138996, -11.619103 ] }, "properties": { "name": "P7:R1-PIN" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.137913, -11.619143 ] }, "properties": { "name": "P8:DOS POSTES-R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.137039, -11.618288 ] }, "properties": { "name": "P-9:DOS POSTES-R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.134680, -11.615675 ] }, "properties": { "name": "P13:S0+1 LP" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.135970, -11.617144 ] }, "properties": { "name": "P10:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.135786, -11.616918 ] }, "properties": { "name": "P11:S0" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.135224, -11.616306 ] }, "properties": { "name": "P12:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.134533, -11.615522 ] }, "properties": { "name": "P14:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.134302, -11.615270 ] }, "properties": { "name": "T15:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.132353, -11.614075 ] }, "properties": { "name": "P16:DOS POSTES-R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131304, -11.613202 ] }, "properties": { "name": "P17:THREE WAY" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.130541, -11.612635 ] }, "properties": { "name": "P18:A1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.130014, -11.611642 ] }, "properties": { "name": "P19:A2" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.129915, -11.609925 ] }, "properties": { "name": "P20:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.129857, -11.609093 ] }, "properties": { "name": "P21:A2*" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.129621, -11.607512 ] }, "properties": { "name": "P22:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.129518, -11.606825 ] }, "properties": { "name": "P23:A2*" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.129442, -11.606174 ] }, "properties": { "name": "P24:A1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.129715, -11.605730 ] }, "properties": { "name": "P25:R1+2 PIN" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.130490, -11.604633 ] }, "properties": { "name": "P26:A1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.130949, -11.604342 ] }, "properties": { "name": "P27:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131240, -11.604151 ] }, "properties": { "name": "P28:R1-PIN" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131423, -11.604024 ] }, "properties": { "name": "P29:R1-PIN" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131623, -11.603544 ] }, "properties": { "name": "P30:R1*+SECC" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131686, -11.603344 ] }, "properties": { "name": "P31:S2*" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131666, -11.602947 ] }, "properties": { "name": "P32:R1" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131618, -11.602350 ] }, "properties": { "name": "P33:S0-1C" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131550, -11.601356 ] }, "properties": { "name": "P34:A1*" } },
        { "type": "Feature", "geometry": { "type": "Point", "coordinates": [ -76.131724, -11.601337 ] }, "properties": { "name": "P35:A2" } },
        { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[-76.142327,-11.621024], [-76.142632,-11.620843], [-76.142945,-11.620642], [-76.143475,-11.620225], [-76.143482,-11.619557], [-76.142415,-11.619263], [-76.141176,-11.618905], [-76.140175,-11.618956], [-76.138995,-11.619103], [-76.137911,-11.619143], [-76.137034,-11.618290], [-76.135969,-11.617146], [-76.135784,-11.616920], [-76.135223,-11.616307], [-76.134679,-11.615676], [-76.134532,-11.615523], [-76.134301,-11.615268], [-76.132350,-11.614074], [-76.131300,-11.613201], [-76.130537,-11.612636], [-76.130011,-11.611643], [-76.129915,-11.609930], [-76.129855,-11.609084], [-76.129621,-11.607511], [-76.129519,-11.606821], [-76.129442,-11.606167], [-76.129717,-11.605728], [-76.130488,-11.604624], [-76.130949,-11.604339], [-76.131240,-11.604148], [-76.131421,-11.604021], [-76.131622,-11.603543], [-76.131685,-11.603344], [-76.131666,-11.602948], [-76.131616,-11.602349], [-76.131549,-11.601355], [-76.131724,-11.601336], [-76.132061,-11.600936]] }, "properties": { "name": "L.3", "stroke": "#ffff00" } },
        { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [ [ -76.154243, -11.614043 ], [ -76.154943, -11.613021 ], [ -76.153813, -11.612988 ] ] }, "properties": { "name": "L.4", "stroke": "#ffff00" } }
      ]
    };

    function togglePanel() { document.getElementById('panel').classList.toggle('escondido'); }
    
    function cambiarTab(tab) {
        document.getElementById('view-voladuras').style.display = (tab === 'voladuras') ? 'block' : 'none';
        document.getElementById('view-gensets').style.display = (tab === 'gensets') ? 'block' : 'none';
        document.getElementById('tab-vol').className = (tab === 'voladuras') ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-gen').className = (tab === 'gensets') ? 'tab-btn active' : 'tab-btn';
    }

    function mostrarReporteGenerico(titulo, filas) {
        var modal = document.getElementById('modal-reporte');
        var contenedor = document.getElementById('contenedor-tabla');
        var tituloSpan = document.getElementById('modal-titulo');
        tituloSpan.innerText = titulo;
        modal.style.display = "flex";
        let htmlTabla = '<table id="tabla-dinamica"><tr><th>DETALLE</th><th>ESTADO</th></tr>';
        filas.forEach(f => { htmlTabla += `<tr><td>${f.nombre}</td><td>${f.estado}</td></tr>`; });
        htmlTabla += '</table>';
        contenedor.innerHTML = htmlTabla;
    }

    async function cargarReporteNativo() {
        var modal = document.getElementById('modal-reporte');
        var contenedor = document.getElementById('contenedor-tabla');
        var tituloSpan = document.getElementById('modal-titulo');
        tituloSpan.innerText = "üìã REPORTE T√âCNICO";
        modal.style.display = "flex";
        contenedor.innerHTML = '<div style="padding:20px; text-align:center; color:grey;">‚è≥ Descargando datos...</div>';
        try {
            const response = await fetch(LINK_REPORTE_CSV + '&t=' + Date.now());
            const text = await response.text();
            const filas = text.split('\n');
            let htmlTabla = '<table id="tabla-dinamica">';
            for (let i = 0; i < filas.length; i++) {
                if(filas[i].trim() === "") continue;
                var celdas = filas[i].split(',');
                htmlTabla += '<tr>';
                for (let j = 0; j < celdas.length; j++) {
                    var tag = (i === 0) ? 'th' : 'td';
                    htmlTabla += `<${tag}>${celdas[j]}</${tag}>`;
                }
                htmlTabla += '</tr>';
            }
            htmlTabla += '</table>';
            contenedor.innerHTML = htmlTabla;
        } catch (error) { contenedor.innerHTML = '<div style="padding:20px; text-align:center; color:red;">‚ùå Error al cargar reporte.</div>'; }
    }

    function cerrarReporte() { document.getElementById('modal-reporte').style.display = "none"; }

    setInterval(() => { document.getElementById("reloj-sistema").innerText = new Date().toLocaleTimeString('es-PE', { hour12: false }); }, 1000);

    proj4.defs("EPSG:32718", "+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
    var map = L.map('map', { zoomControl: false }).setView([-11.619, -76.08], 13);
    var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
    var mapaPlano = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
    var mapaTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'OTM' });
    mapaSatelite.addTo(map);
    
    var capaVoladuras = L.layerGroup().addTo(map);
    var capaGensets = L.layerGroup().addTo(map);
    var capaGPS = L.layerGroup().addTo(map);
    var capaTormentas = L.layerGroup().addTo(map);
    var lineaDistancia = L.layerGroup().addTo(map);

    // --- MODO FANTASMA (Opacidad Cero) ---
    function estiloEnergia(feature) { return { color: feature.properties.stroke || "#f1c40f", weight: 2, opacity: 0, dashArray: '5, 5' }; }
    function estiloPuntos(feature, latlng) { return L.circleMarker(latlng, { radius: 3, fillColor: "#00ffff", color: "#000", weight: 1, opacity: 0, fillOpacity: 0 }); }

    var capaEnergia = L.geoJSON(datosEnergia, {
        style: estiloEnergia,
        pointToLayer: estiloPuntos,
        onEachFeature: function (feature, layer) { if (feature.properties && feature.properties.name) { layer.bindPopup("üîå <b>" + feature.properties.name + "</b>"); } }
    }).addTo(map);

    L.control.layers( { "üåé Sat√©lite": mapaSatelite, "üó∫Ô∏è Plano": mapaPlano, "‚õ∞Ô∏è Topogr√°fico": mapaTopo }, { "‚ö° Sensores": capaTormentas, "üí• Voladuras": capaVoladuras, "üü£ Gensets": capaGensets, "üîå L√≠neas El√©ctricas": capaEnergia }, { position: 'topright' } ).addTo(map);

    const sensores = [ { nombre: "MINA", lat: -11.61543, lon: -76.14331 }, { nombre: "CARHUACOTO", lat: -11.58529, lon: -76.06169 }, { nombre: "TUNSHURUCO", lat: -11.67360, lon: -76.13777 }, { nombre: "KINGSMILL", lat: -11.63342, lon: -76.05691 } ];
    sensores.forEach(s => { L.marker([s.lat, s.lon], {icon: L.divIcon({html:'‚ö°', className:''})}).addTo(capaTormentas); L.circle([s.lat, s.lon], {radius: 5200, color:'#3498db', fillColor:'#3498db', fillOpacity:0.15, weight:1}).addTo(capaTormentas); });

    var zonasProgramadas = [];
    var zonasActivasAhora = []; 
    var postesAfectados = [];
    var intervaloChequeo = null;

    function actualizarTodo() { cargarVoladuras(); cargarGensets(); }

    async function cargarVoladuras() {
        var btn = document.querySelector(".btn-sync");
        btn.innerHTML = "‚è≥ CARGANDO...";
        try {
            const response = await fetch(LINK_VOLADURAS + '&t=' + Date.now());
            const text = await response.text();
            zonasProgramadas = [];
            const filas = text.split('\n');
            for (let i = 1; i < filas.length; i++) {
                const col = filas[i].split(',');
                if (col.length >= 6 && col[0].trim() !== "") {
                    zonasProgramadas.push({ n: parseFloat(col[0]), e: parseFloat(col[1]), r: parseFloat(col[2]), detalle: col[3], hora: col[4].trim(), dur: parseInt(col[5]) });
                }
            }
            if (intervaloChequeo) clearInterval(intervaloChequeo);
            actualizarMapaSegunHora();
            intervaloChequeo = setInterval(actualizarMapaSegunHora, 1000);
            btn.innerHTML = "‚úÖ LISTO"; setTimeout(() => { btn.innerHTML = "üîÑ ACTUALIZAR DATOS"; }, 3000);
        } catch (err) { console.error(err); btn.innerHTML = "‚ùå ERROR VOL"; }
    }

    async function cargarGensets() {
        if (!LINK_GENSETS.startsWith("http")) return; 
        try {
            const response = await fetch(LINK_GENSETS + '&t=' + Date.now());
            const text = await response.text();
            const filas = text.split('\n');
            capaGensets.clearLayers();
            const listaDiv = document.getElementById("lista-gensets");
            listaDiv.innerHTML = "";
            for (let i = 1; i < filas.length; i++) {
                const col = filas[i].split(',');
                if (col.length >= 4 && col[0].trim() !== "") {
                    const n = parseFloat(col[0]); const e = parseFloat(col[1]); const nombre = col[2]; const estado = col[3] ? col[3].trim().toUpperCase() : ""; const lugar = col[4] || "Sin datos"; const horas = col[5] || "-"; const tension = col[6] || "-";
                    if (estado.includes("TRABAJANDO") && !isNaN(n)) {
                        try {
                            const c = proj4("EPSG:32718", "EPSG:4326", [e, n]);
                            const lat = c[1]; const lon = c[0];
                            const iconoGenset = L.divIcon({ className: 'genset-marker', html: `<svg viewBox="0 0 24 24"><path d="M4 6h16v10H4z"/><path d="M6 8h12v6H6z" fill="#8e44ad"/><path d="M7 9h3v4H7zm4 0h3v4h-3zm4 0h3v4h-3z" fill="white"/><path d="M5 16v3h2v-3m10 0v3h2v-3" stroke="white" stroke-width="2"/></svg>`, iconSize: [28, 28], iconAnchor: [14, 14] });
                            const popupContent = `<div style="min-width:180px;"><h3 style="margin:0; color:#8e44ad;">${nombre}</h3><table class="tabla-info"><tr><td>Estado:</td><td><b style="color:#27ae60">${estado}</b></td></tr><tr><td>Lugar:</td><td>${lugar}</td></tr><tr><td>Horas:</td><td>${horas} hrs</td></tr><tr><td>Tensi√≥n:</td><td>${tension}</td></tr><tr><td>Coord:</td><td><small>${n}, ${e}</small></td></tr></table></div>`;
                            L.marker([lat, lon], {icon: iconoGenset}).bindPopup(popupContent).addTo(capaGensets);
                            listaDiv.innerHTML += `<div class="list-item genset-item" onclick="viajarA(${lat}, ${lon})"><div><strong>${nombre}</strong><br><small>${lugar}</small></div><div style="font-size:1.2em; color:#8e44ad">‚ö°</div></div>`;
                        } catch(e) {}
                    }
                }
            }
            if (listaDiv.innerHTML === "") listaDiv.innerHTML = "<div style='text-align:center;color:grey'>No hay gensets activos.</div>";
        } catch (err) { console.error("Error Gensets", err); }
    }

    window.viajarA = function(lat, lon) { map.flyTo([lat, lon], 18); if (window.innerWidth < 600) togglePanel(); };

    function actualizarMapaSegunHora() {
        const ahora = new Date();
        const listaDiv = document.getElementById("lista-voladuras");
        const alertaDiv = document.getElementById("radio-silence-alert");
        listaDiv.innerHTML = ""; capaVoladuras.clearLayers(); 
        let haySilencioRadial = false; zonasActivasAhora = [];

        zonasProgramadas.forEach(zona => {
            if (!zona.hora) return;
            const [hh, mm] = zona.hora.split(':');
            const fechaInicio = new Date(); fechaInicio.setHours(hh, mm, 0);
            const fechaFin = new Date(fechaInicio.getTime() + zona.dur * 60000);
            let estadoTexto = ""; let colorBorde = ""; let colorMapa = ""; let dibujar = false; let esPeligroso = false;

            if (ahora > fechaFin) {
                estadoTexto = "FINALIZADO"; colorBorde = "#7f8c8d";
            } else if (ahora >= fechaInicio && ahora <= fechaFin) {
                estadoTexto = "üö® EN EJECUCI√ìN"; colorBorde = "#e74c3c"; colorMapa = "red"; dibujar = true; haySilencioRadial = true; esPeligroso = true;
            } else {
                estadoTexto = "‚è≥ PROGRAMADO"; colorBorde = "#f39c12"; colorMapa = "orange"; dibujar = true; esPeligroso = true;
            }

            if (dibujar && !isNaN(zona.n)) {
                try {
                    const c = proj4("EPSG:32718", "EPSG:4326", [zona.e, zona.n]);
                    if (esPeligroso) zonasActivasAhora.push({ center: L.latLng(c[1], c[0]), radius: zona.r, name: zona.detalle, type: colorMapa });
                    const colorHex = (colorMapa === "red") ? "#e74c3c" : "#f39c12";
                    const opacidad = (colorMapa === "red") ? 0.5 : 0.2;
                    L.circle([c[1], c[0]], { radius: zona.r, color: colorHex, fillColor: colorHex, fillOpacity: opacidad, weight: 2 }).bindPopup(`<b>${zona.detalle}</b><br>${zona.hora}`).addTo(capaVoladuras);
                } catch(e) {}
            }

            if (estadoTexto !== "FINALIZADO" || (ahora - fechaFin) < 7200000) {
                listaDiv.innerHTML += `<div class="list-item" style="border-left-color: ${colorBorde};"><div><strong style="font-size:1.1em">${zona.detalle}</strong><br><span style="color:${colorBorde}; font-weight:bold;">${estadoTexto}</span></div><div style="text-align:right;">${zona.hora}<br><small>${zona.dur} min</small></div></div>`;
            }
        });

        alertaDiv.style.display = haySilencioRadial ? "block" : "none";
        if (listaDiv.innerHTML === "") listaDiv.innerHTML = "<div style='text-align:center; padding:10px; color:#7f8c8d;'>Sin voladuras pendientes.</div>";
        if (miPosicion) chequearProximidadVoladura();
        verificarInterferencias(); 
    }

    function verificarInterferencias() {
        postesAfectados = []; 
        capaEnergia.eachLayer(function(layer) {
            // Resetear al modo fantasma (invisible)
            if (layer instanceof L.CircleMarker) { layer.setStyle({ fillColor: "#00ffff", color: "#000", radius: 3, opacity: 0, fillOpacity: 0 }); } 
            else if (layer instanceof L.Polyline) { layer.setStyle({ color: layer.feature.properties.stroke || "#f1c40f", weight: 2, dashArray: '5, 5', opacity: 0 }); }
        });

        if (zonasActivasAhora.length === 0) { document.getElementById('btn-interferencia').style.display = 'none'; return; }

        zonasActivasAhora.forEach(zona => {
            capaEnergia.eachLayer(function(layer) {
                let afectado = false;
                if (layer instanceof L.CircleMarker) {
                    if (map.distance(layer.getLatLng(), zona.center) <= zona.radius) afectado = true;
                } else if (layer instanceof L.Polyline) {
                    let puntos = layer.getLatLngs().flat ? layer.getLatLngs().flat(99) : layer.getLatLngs(); 
                    for (let p of puntos) { if (map.distance(p, zona.center) <= zona.radius) { afectado = true; break; } }
                }

                if (afectado) {
                    postesAfectados.push({ nombre: layer.feature.properties.name || "Sin Nombre", estado: "‚ö†Ô∏è " + zona.name });
                    if (layer instanceof L.CircleMarker) {
                        layer.setStyle({ fillColor: "red", color: "white", radius: 6, weight: 2, opacity: 1, fillOpacity: 1 });
                        layer.bindPopup("üö® <b>¬°AFECTADO!</b><br>" + (layer.feature.properties.name || "Sin nombre"));
                    } else {
                        layer.setStyle({ color: "red", weight: 5, dashArray: null, opacity: 1 });
                    }
                }
            });
        });

        var btnAlert = document.getElementById('btn-interferencia');
        if (postesAfectados.length > 0) {
            btnAlert.style.display = 'block';
            btnAlert.innerText = `üö® VER ${postesAfectados.length} POSTES AFECTADOS`;
            enviarNotificacion("ALERTA", `Se detectaron ${postesAfectados.length} interferencias.`);
        } else {
            btnAlert.style.display = 'none';
        }
    }

    function mostrarTablaInterferencias() { mostrarReporteGenerico("‚ö†Ô∏è POSTES AFECTADOS", postesAfectados); }

    var notificacionEnviada = false;
    function pedirPermisoNotificaciones() {
        if (!("Notification" in window)) alert("No soportado");
        else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(function (p) { if (p === "granted") { alert("Notificaciones Activadas"); document.getElementById('btn-permiso').style.display = 'none'; } });
        }
    }
    function enviarNotificacion(t, c) {
        if (Notification.permission === "granted" && !notificacionEnviada) {
            new Notification("üö® ALERTA TOROMOCHO", { body: t + ": " + c });
            notificacionEnviada = true; setTimeout(() => { notificacionEnviada = false; }, 300000); 
        }
    }
    if (Notification.permission !== "granted" && "Notification" in window) document.getElementById('btn-permiso').style.display = 'block';

    var truckIcon = L.divIcon({ className: 'car-container', html: `<svg class="car-icon" viewBox="0 0 24 24" fill="#00FF00" xmlns="http://www.w3.org/2000/svg"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5H6.5C5.84 5 5.28 5.42 5.08 6.01L3 12V20C3 20.55 3.45 21 4 21H5C5.55 21 6 20.55 6 20V19H18V20C18 20.55 18.45 21 19 21H20C20.55 21 21 20.55 21 20V12L18.92 6.01ZM6.5 16C5.67 16 5 15.33 5 14.5C5 13.67 5.67 13 6.5 13C7.33 13 8 13.67 8 14.5C8 15.33 7.33 16 6.5 16ZM17.5 16C16.67 16 16 15.33 16 14.5C16 13.67 16.67 13 17.5 13C18.33 13 19 13.67 19 14.5C19 15.33 18.33 16 17.5 16ZM5 11L6.5 6.5H17.5L19 11H5Z"/></svg>`, iconSize: [30, 30], iconAnchor: [15, 15] });
    var marcadorVehiculo = null;
    var miPosicion = null;

    function iniciarSeguimiento() {
        var btn = document.getElementById("btnGps");
        if (!navigator.geolocation) { alert("Sin GPS"); return; }
        btn.innerHTML = "üîÑ BUSCANDO..."; btn.style.backgroundColor = "#e67e22";
        navigator.geolocation.watchPosition((pos) => {
            var lat = pos.coords.latitude; var lon = pos.coords.longitude;
            miPosicion = L.latLng(lat, lon);
            try {
                var utm = proj4("EPSG:4326", "EPSG:32718", [lon, lat]);
                document.getElementById("utm-display").innerHTML = `N: ${utm[1].toFixed(0)} | E: ${utm[0].toFixed(0)}`;
            } catch(e) {}
            btn.innerHTML = "‚úÖ GPS ACTIVO"; btn.style.backgroundColor = "#27ae60";
            if (!marcadorVehiculo) { marcadorVehiculo = L.marker([lat, lon], {icon: truckIcon}).addTo(capaGPS); map.flyTo([lat, lon], 16); }
            else { marcadorVehiculo.setLatLng([lat, lon]); }
            chequearTormentas(); chequearProximidadVoladura();
        }, (err) => { btn.innerHTML = "‚ö†Ô∏è SIN SE√ëAL"; btn.style.backgroundColor = "#c0392b"; }, { enableHighAccuracy: true });
    }

    function chequearProximidadVoladura() {
        if (!miPosicion || zonasActivasAhora.length === 0) { document.getElementById("proximity-box").style.display = "none"; return; }
        var box = document.getElementById("proximity-box");
        var alertaActiva = false; var mensaje = ""; var claseCritica = false;
        lineaDistancia.clearLayers();
        const UMBRAL = 1000;
        zonasActivasAhora.forEach(zona => {
            var distCentro = map.distance(miPosicion, zona.center);
            var distBorde = distCentro - zona.radius;
            if (distBorde <= 0) {
                alertaActiva = true; claseCritica = true; mensaje = `‚õî ¬°PELIGRO!<br>EST√ÅS DENTRO DE: ${zona.name}`;
                L.polyline([miPosicion, zona.center], {color: 'red', weight: 4}).addTo(lineaDistancia);
                enviarNotificacion("PELIGRO PERSONAL", "Usted est√° DENTRO de zona de voladura");
            } else if (distBorde <= UMBRAL) {
                if (!claseCritica) {
                    alertaActiva = true; mensaje = `‚ö†Ô∏è PRECAUCI√ìN<br>A ${distBorde.toFixed(0)}m de: ${zona.name}`;
                    L.polyline([miPosicion, zona.center], {color: 'orange', dashArray: '5, 10'}).addTo(lineaDistancia);
                }
            }
        });
        if (alertaActiva) { box.style.display = "block"; box.innerHTML = mensaje; box.className = claseCritica ? "proximity-alert proximity-critical" : "proximity-alert"; }
        else { box.style.display = "none"; }
    }

    function chequearTormentas() {
        if (!miPosicion) return;
        var box = document.getElementById("storm-box");
        var detectados = [];
        sensores.forEach(s => { if (map.distance(miPosicion, [s.lat, s.lon]) < 5200) detectados.push(s.nombre); });
        if (detectados.length > 0) { box.style.display = "block"; box.innerHTML = `‚ö° EN SENSOR: <br>${detectados.join(" y ")}`; }
        else { box.style.display = "none"; }
    }

    window.onload = function() { actualizarTodo(); }
</script>
</body>
</html>