<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA GESTI√ìN TOROMOCHO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- ESTILOS VISUALES --- */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        #menu-toggle {
            position: absolute; top: 10px; left: 10px; z-index: 1100;
            background: #2c3e50; color: white; border: none; border-radius: 4px;
            width: 40px; height: 40px; font-size: 1.5em; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        #panel { 
            position: absolute; top: 60px; left: 10px; width: 260px; 
            background: rgba(33, 47, 61, 0.95); color: white; padding: 10px; 
            border-radius: 8px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            max-height: 85vh; overflow-y: auto; transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }
        #panel.escondido { transform: translateX(-350%); }

        h4 { margin: 10px 0 5px 0; font-size: 0.8em; color: #2ecc71; text-transform: uppercase; text-align: center; border-bottom: 1px solid #555; padding-bottom: 5px; }
        
        button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 0.8em; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-gps { background: #2980b9; color: white; }
        .btn-sync { background: #8e44ad; color: white; } 
        .btn-debug { background: #34495e; color: #bdc3c7; font-size: 0.7em; padding: 5px; } /* Nuevo Bot√≥n */

        #radio-silence-alert {
            position: absolute; bottom: 30px; left: 20px; right: 20px;
            background: rgba(231, 76, 60, 0.95); color: white;
            padding: 15px; border-radius: 8px; text-align: center;
            font-weight: 900; font-size: 1.2em; z-index: 2000;
            border: 4px solid white; display: none;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            text-transform: uppercase;
            animation: parpadeo-fuerte 0.8s infinite alternate;
        }

        @keyframes parpadeo-fuerte { from { opacity: 1; transform: scale(1); } to { opacity: 0.9; transform: scale(1.02); } }

        #reloj-sistema { 
            font-family: monospace; color: #f1c40f; text-align: center; 
            font-size: 1.4em; margin-bottom: 10px; border: 1px solid #555; 
            padding: 5px; border-radius: 4px; background: rgba(0,0,0,0.3);
        }

        .status-row { 
            background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 6px; 
            border-radius: 4px; font-size: 0.75em; border-left: 4px solid grey;
            display: flex; justify-content: space-between; align-items: center;
        }

        .storm-alert {
            background: rgba(52, 152, 219, 0.2); border: 2px solid #3498db;
            color: #f1c40f; padding: 10px; margin-bottom: 10px; border-radius: 5px;
            text-align: center; font-size: 0.8em; display: none; font-weight: bold;
        }

        .proximity-alert {
            background: rgba(243, 156, 18, 0.2); border: 2px solid #f39c12;
            color: #e67e22; padding: 10px; margin-bottom: 10px; border-radius: 5px;
            text-align: center; font-size: 0.9em; display: none; font-weight: bold;
            animation: parpadeo-suave 1s infinite alternate;
        }
        .proximity-critical { background: rgba(231, 76, 60, 0.3); border: 2px solid #c0392b; color: #ff6b6b; }
        @keyframes parpadeo-suave { from { opacity: 0.8; } to { opacity: 1; } }

        /* VISOR DE DEPURACI√ìN (OCULTO POR DEFECTO) */
        #debug-console {
            display: none; background: #000; color: #0f0; font-family: monospace;
            font-size: 0.6em; padding: 5px; margin-top: 5px; border: 1px solid #0f0;
            max-height: 100px; overflow-y: scroll; text-align: left;
        }

        .footer-dev { margin-top: 20px; padding-top: 10px; border-top: 1px solid #555; text-align: center; font-size: 0.6em; color: #95a5a6; }
        .footer-dev b { color: #3498db; }
        .car-icon { width: 30px; height: 30px; filter: drop-shadow(0px 0px 3px black); }
        .leaflet-control-layers { border-radius: 8px; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="radio-silence-alert">
    üö´ SILENCIO RADIAL ACTIVO üö´<br>
    <span style="font-size:0.6em; font-weight:normal;">ZONA ROJA ACTIVADA</span>
</div>

<button id="menu-toggle" onclick="togglePanel()">‚ò∞</button>

<div id="panel">
    <div id="reloj-sistema">--:--:--</div>
    
    <div id="storm-box" class="storm-alert"></div>
    <div id="proximity-box" class="proximity-alert"></div>

    <button id="btnGps" class="btn-gps" onclick="iniciarSeguimiento()">üìç ACTIVAR MI GPS</button>
    <div id="utm-display" style="text-align:center; font-size:0.7em; color:#f39c12; margin-bottom:10px; font-family:monospace;">Esperando se√±al...</div>

    <h4>üì° Voladuras de Hoy</h4>
    
    <button class="btn-sync" onclick="cargarDesdeGoogle()">üîÑ ACTUALIZAR DE EXCEL</button>
    
    <button class="btn-debug" onclick="toggleDebug()">üëÅÔ∏è VER DATOS CRUDOS (DEBUG)</button>
    <div id="debug-console">Esperando datos...</div>
    
    <div id="lista-voladuras" style="margin-top: 15px;">
        <div style="text-align:center; color:#bdc3c7; font-size:0.8em; padding:20px;">
            <i>Cargando datos...</i>
        </div>
    </div>

    <div class="footer-dev">Dev: <b>Johann Handel CP</b></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<script>
    // üîó TU ENLACE GOOGLE SHEETS
    var GOOGLE_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5BO75yc_nkIUxS-nPmodwWpYnbeIdILokPgV4ncqCPB09_23bp_zMHDVRXVmkBoP6gihaB1aVE-yJ/pub?gid=0&single=true&output=csv";

    function togglePanel() { document.getElementById('panel').classList.toggle('escondido'); }
    function toggleDebug() { 
        var d = document.getElementById('debug-console'); 
        d.style.display = (d.style.display === 'block') ? 'none' : 'block'; 
    }

    // 1. RELOJ
    setInterval(() => {
        const ahora = new Date();
        document.getElementById("reloj-sistema").innerText = 
            ahora.toLocaleTimeString('es-PE', { hour12: false });
    }, 1000);

    // 2. MAPA
    proj4.defs("EPSG:32718", "+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
    var map = L.map('map', { zoomControl: false }).setView([-11.619, -76.08], 13);

    var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
    var mapaPlano = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
    var mapaTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'OTM' });

    mapaSatelite.addTo(map);
    
    var capaVoladuras = L.layerGroup().addTo(map);
    var capaGPS = L.layerGroup().addTo(map);
    var capaTormentas = L.layerGroup().addTo(map);
    var lineaDistancia = L.layerGroup().addTo(map);

    L.control.layers(
        { "üåé Sat√©lite": mapaSatelite, "üó∫Ô∏è Plano": mapaPlano, "‚õ∞Ô∏è Topogr√°fico": mapaTopo }, 
        { "‚ö° Sensores": capaTormentas, "üí• Voladuras": capaVoladuras }, 
        { position: 'topright' }
    ).addTo(map);

    // 3. SENSORES TORMENTA
    const sensores = [
        { nombre: "MINA", lat: -11.61543, lon: -76.14331 },
        { nombre: "CARHUACOTO", lat: -11.58529, lon: -76.06169 },
        { nombre: "TUNSHURUCO", lat: -11.67360, lon: -76.13777 },
        { nombre: "KINGSMILL", lat: -11.63342, lon: -76.05691 }
    ];
    sensores.forEach(s => {
        L.marker([s.lat, s.lon], {icon: L.divIcon({html:'‚ö°', className:''})}).addTo(capaTormentas);
        L.circle([s.lat, s.lon], {radius: 5200, color:'#3498db', fillColor:'#3498db', fillOpacity:0.15, weight:1}).addTo(capaTormentas);
    });

    // 4. CARGA DE DATOS AGRESIVA
    var zonasProgramadas = [];
    var zonasActivasAhora = []; 
    var intervaloChequeo = null;

    async function cargarDesdeGoogle() {
        var btn = document.querySelector(".btn-sync");
        var debug = document.getElementById("debug-console");
        btn.innerHTML = "‚è≥ CONECTANDO...";
        
        try {
            // A√±adimos un n√∫mero aleatorio grande para asegurar que no se use cach√©
            const nocache = Math.floor(Math.random() * 999999);
            const response = await fetch(GOOGLE_CSV_LINK + '&t=' + Date.now() + '&nocache=' + nocache, {
                cache: "no-store", // Orden directa al navegador de NO guardar nada
                headers: { 'Pragma': 'no-cache', 'Cache-Control': 'no-cache' }
            });
            
            const text = await response.text();
            
            // Debug: Mostrar lo que llega realmente
            debug.innerHTML = "<b>RECIBIDO DE GOOGLE:</b><br>" + text.substring(0, 200) + "...";

            zonasProgramadas = [];
            const filas = text.split('\n');

            for (let i = 1; i < filas.length; i++) {
                const col = filas[i].split(',');
                if (col.length >= 6 && col[0].trim() !== "") {
                    zonasProgramadas.push({
                        n: parseFloat(col[0]), e: parseFloat(col[1]), r: parseFloat(col[2]),
                        detalle: col[3], hora: col[4].trim(), dur: parseInt(col[5])
                    });
                }
            }
            btn.innerHTML = "‚úÖ SINCRONIZADO";
            setTimeout(() => { btn.innerHTML = "üîÑ ACTUALIZAR DE EXCEL"; }, 3000);

            if (intervaloChequeo) clearInterval(intervaloChequeo);
            actualizarMapaSegunHora();
            intervaloChequeo = setInterval(actualizarMapaSegunHora, 1000);
        } catch (err) {
            console.error(err);
            alert("Error de Red. Revisa tu internet.");
            btn.innerHTML = "‚ùå ERROR";
        }
    }

    function actualizarMapaSegunHora() {
        const ahora = new Date();
        const listaDiv = document.getElementById("lista-voladuras");
        const alertaDiv = document.getElementById("radio-silence-alert");
        
        listaDiv.innerHTML = ""; 
        capaVoladuras.clearLayers(); 
        let haySilencioRadial = false;
        zonasActivasAhora = [];

        zonasProgramadas.forEach(zona => {
            if (!zona.hora) return;

            const [hh, mm] = zona.hora.split(':');
            const fechaInicio = new Date();
            fechaInicio.setHours(hh, mm, 0);
            const fechaFin = new Date(fechaInicio.getTime() + zona.dur * 60000);

            let estadoTexto = "";
            let colorBorde = "";
            let colorMapa = "";
            let dibujar = false;
            let esPeligroso = false;

            if (ahora > fechaFin) {
                estadoTexto = "FINALIZADO"; colorBorde = "#7f8c8d";
            } else if (ahora >= fechaInicio && ahora <= fechaFin) {
                estadoTexto = "üö® EN EJECUCI√ìN"; colorBorde = "#e74c3c";
                colorMapa = "red"; dibujar = true; haySilencioRadial = true; esPeligroso = true;
            } else {
                estadoTexto = "‚è≥ PROGRAMADO"; colorBorde = "#f39c12";
                colorMapa = "orange"; dibujar = true; esPeligroso = true;
            }

            if (dibujar && !isNaN(zona.n)) {
                try {
                    const c = proj4("EPSG:32718", "EPSG:4326", [zona.e, zona.n]);
                    if (esPeligroso) zonasActivasAhora.push({ center: L.latLng(c[1], c[0]), radius: zona.r, name: zona.detalle, type: colorMapa });

                    const colorHex = (colorMapa === "red") ? "#e74c3c" : "#f39c12";
                    const opacidad = (colorMapa === "red") ? 0.5 : 0.2;
                    L.circle([c[1], c[0]], { radius: zona.r, color: colorHex, fillColor: colorHex, fillOpacity: opacidad, weight: 2 }).bindPopup(`<b>${zona.detalle}</b><br>Inicio: ${zona.hora}`).addTo(capaVoladuras);
                } catch(e) {}
            }

            if (estadoTexto !== "FINALIZADO" || (ahora - fechaFin) < 7200000) {
                listaDiv.innerHTML += `
                    <div class="status-row" style="border-left-color: ${colorBorde};">
                        <div><strong style="font-size:1.1em">${zona.detalle}</strong><br><span style="color:${colorBorde}; font-weight:bold;">${estadoTexto}</span></div>
                        <div style="text-align:right;">${zona.hora}<br><small>${zona.dur} min</small></div>
                    </div>`;
            }
        });

        alertaDiv.style.display = haySilencioRadial ? "block" : "none";
        if (listaDiv.innerHTML === "") listaDiv.innerHTML = "<div style='text-align:center; padding:10px; color:#7f8c8d;'>Sin voladuras pendientes.</div>";
    }

    // 5. GPS PROXIMIDAD
    var truckIcon = L.divIcon({ className: 'car-container', html: `<svg class="car-icon" viewBox="0 0 24 24" fill="#00FF00" xmlns="http://www.w3.org/2000/svg"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5H6.5C5.84 5 5.28 5.42 5.08 6.01L3 12V20C3 20.55 3.45 21 4 21H5C5.55 21 6 20.55 6 20V19H18V20C18 20.55 18.45 21 19 21H20C20.55 21 21 20.55 21 20V12L18.92 6.01ZM6.5 16C5.67 16 5 15.33 5 14.5C5 13.67 5.67 13 6.5 13C7.33 13 8 13.67 8 14.5C8 15.33 7.33 16 6.5 16ZM17.5 16C16.67 16 16 15.33 16 14.5C16 13.67 16.67 13 17.5 13C18.33 13 19 13.67 19 14.5C19 15.33 18.33 16 17.5 16ZM5 11L6.5 6.5H17.5L19 11H5Z"/></svg>`, iconSize: [30, 30], iconAnchor: [15, 15] });
    var marcadorVehiculo = null;
    var miPosicion = null;

    function iniciarSeguimiento() {
        var btn = document.getElementById("btnGps");
        if (!navigator.geolocation) { alert("Sin GPS"); return; }
        btn.innerHTML = "üîÑ BUSCANDO..."; btn.style.backgroundColor = "#e67e22";
        navigator.geolocation.watchPosition(
            (pos) => {
                var lat = pos.coords.latitude; var lon = pos.coords.longitude;
                miPosicion = L.latLng(lat, lon);
                try {
                    var utm = proj4("EPSG:4326", "EPSG:32718", [lon, lat]);
                    document.getElementById("utm-display").innerHTML = `N: ${utm[1].toFixed(0)} | E: ${utm[0].toFixed(0)}`;
                } catch(e) {}
                btn.innerHTML = "‚úÖ GPS ACTIVO"; btn.style.backgroundColor = "#27ae60";
                if (!marcadorVehiculo) { marcadorVehiculo = L.marker([lat, lon], {icon: truckIcon}).addTo(capaGPS); map.flyTo([lat, lon], 16); }
                else { marcadorVehiculo.setLatLng([lat, lon]); }
                chequearTormentas(); chequearProximidadVoladura();
            },
            (err) => { btn.innerHTML = "‚ö†Ô∏è SIN SE√ëAL"; btn.style.backgroundColor = "#c0392b"; }, { enableHighAccuracy: true }
        );
    }

    function chequearProximidadVoladura() {
        if (!miPosicion || zonasActivasAhora.length === 0) return;
        var box = document.getElementById("proximity-box");
        var alertaActiva = false; var mensaje = ""; var claseCritica = false;
        lineaDistancia.clearLayers();
        const UMBRAL_ADVERTENCIA = 1000;

        zonasActivasAhora.forEach(zona => {
            var distCentro = map.distance(miPosicion, zona.center);
            var distBorde = distCentro - zona.radius;
            if (distBorde <= 0) {
                alertaActiva = true; claseCritica = true;
                mensaje = `‚õî ¬°PELIGRO!<br>EST√ÅS DENTRO DE: ${zona.name}`;
                L.polyline([miPosicion, zona.center], {color: 'red', weight: 4}).addTo(lineaDistancia);
            } else if (distBorde <= UMBRAL_ADVERTENCIA) {
                if (!claseCritica) {
                    alertaActiva = true;
                    mensaje = `‚ö†Ô∏è PRECAUCI√ìN<br>A ${distBorde.toFixed(0)}m de: ${zona.name}`;
                    L.polyline([miPosicion, zona.center], {color: 'orange', dashArray: '5, 10'}).addTo(lineaDistancia);
                }
            }
        });

        if (alertaActiva) {
            box.style.display = "block"; box.innerHTML = mensaje;
            box.className = claseCritica ? "proximity-alert proximity-critical" : "proximity-alert";
        } else { box.style.display = "none"; }
    }

    function chequearTormentas() {
        if (!miPosicion) return;
        var box = document.getElementById("storm-box");
        var detectados = [];
        sensores.forEach(s => {
            if (map.distance(miPosicion, [s.lat, s.lon]) < 5200) detectados.push(s.nombre);
        });
        if (detectados.length > 0) {
            box.style.display = "block"; box.innerHTML = `‚ö° ESTAS EN SENSOR: <br>${detectados.join(" y ")}`;
        } else { box.style.display = "none"; }
    }

    window.onload = function() { cargarDesdeGoogle(); }
</script>
</body>
</html>